@using arna.HRMS.Components.lib.components.ui.Model

<div class="emp-wrapper">
    <div class="emp-display" @onclick="Toggle">
        <span class="emp-text">@DisplayText</span>
        <span class="emp-arrow @(IsOpen ? "open" : "")"></span>
    </div>

    @if (IsOpen)
    {
        <div class="emp-backdrop" @onclick="Close"></div>

        <div class="emp-panel">

            <!-- 🔍 SEARCH -->
            <input class="emp-search"
                   placeholder="Search employee..."
                   @bind="SearchText"
                   @bind:event="oninput" />

            <div class="emp-list">

                <button type="button"
                        class="emp-item @(SelectedValue == "0" ? "active" : "")"
                        @onclick='() => Select("0")'>
                    Select Employee
                </button>

                @foreach (var emp in FilteredEmployees)
                {
                    <button type="button"
                            class="emp-item @(emp.Value == SelectedValue ? "active" : "")"
                            @onclick="() => Select(emp.Value)">
                        @emp.Text
                    </button>
                }
            </div>
        </div>
    }
</div>

@code {
    /* ================= PARAMETERS ================= */
    [Parameter] public List<SelectOption>? Employees { get; set; }
    [Parameter] public string? SelectedValue { get; set; }
    [Parameter] public EventCallback<string?> OnChanged { get; set; }
    [Parameter] public EventCallback<string?> OnNameChanged { get; set; }

    /* ================= STATE ================= */
    private bool IsOpen;
    private string SearchText = string.Empty;

    /* ================= SAFE COLLECTION ================= */
    private IEnumerable<SelectOption> SafeEmployees =>
        Employees ?? Enumerable.Empty<SelectOption>();

    /* ================= FILTER ================= */
    private IEnumerable<SelectOption> FilteredEmployees =>
        string.IsNullOrWhiteSpace(SearchText)
            ? SafeEmployees
            : SafeEmployees.Where(e =>
                !string.IsNullOrWhiteSpace(e.Text) &&
                e.Text.Contains(SearchText, StringComparison.OrdinalIgnoreCase));

    /* ================= DISPLAY TEXT (FIXED) ================= */
    private string DisplayText
    {
        get
        {
            if (string.IsNullOrWhiteSpace(SelectedValue) || SelectedValue == "0")
                return "Select Employee";

            return SafeEmployees
                       .FirstOrDefault(e => e.Value == SelectedValue)?.Text
                   ?? "Select Employee";
        }
    }

    /* ================= UI HANDLERS ================= */
    private void Toggle() => IsOpen = !IsOpen;

    private async Task Close()
    {
        IsOpen = false;
        await ResetSelect();
    }

    private async Task ResetSelect()
    {
        SearchText = string.Empty;
        SelectedValue = null;

        await OnChanged.InvokeAsync(null);
        await OnNameChanged.InvokeAsync(null);
    }

    private async Task Select(string value)
    {
        IsOpen = false;
        SearchText = string.Empty;

        var text = SafeEmployees.FirstOrDefault(e => e.Value == value)?.Text;

        await OnChanged.InvokeAsync(value == "0" ? null : value);
        await OnNameChanged.InvokeAsync(text);
    }
}
