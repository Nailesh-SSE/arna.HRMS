@using System.Linq.Expressions
@using Microsoft.AspNetCore.Components.Forms
@using System.Globalization

<div class="mb-3">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="form-label">@Label</label>
    }

    <input type="number"
           class="form-control"
           value="@BindConverter.FormatValue(Value)"
           readonly="@ReadOnly"
           disabled="@Disabled"
           @onchange="OnChange"
           @attributes="AdditionalAttributes" />

    @if (ValidationExpression != null)
    {
        <ValidationMessage For="ValidationExpression" />
    }

    @ChildContent
</div>

@code {
    [CascadingParameter] private EditContext? EditContext { get; set; }

    [Parameter] public string Label { get; set; } = "";

    // ⭐ EXACT types (no nullable mismatch)
    [Parameter] public int Value { get; set; }
    [Parameter] public EventCallback<int> ValueChanged { get; set; }

    [Parameter] public Expression<Func<int>>? ValidationExpression { get; set; }

    [Parameter] public RenderFragment? ChildContent { get; set; }

    [Parameter] public bool ReadOnly { get; set; }
    [Parameter] public bool Disabled { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private FieldIdentifier _fieldIdentifier;

    protected override void OnParametersSet()
    {
        if (EditContext != null && ValidationExpression != null)
        {
            _fieldIdentifier = FieldIdentifier.Create(ValidationExpression);
        }
    }

    private async Task OnChange(ChangeEventArgs e)
    {
        if (ReadOnly || Disabled)
            return;

        if (BindConverter.TryConvertTo<int>(
            e.Value,
            CultureInfo.CurrentCulture,
            out var result))
        {
            await ValueChanged.InvokeAsync(result);
            EditContext?.NotifyFieldChanged(_fieldIdentifier);
        }
    }
}
