@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions

<div class="mb-1">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="form-label">
            @Label
            @if (IsRequired)
            {
                <span class="text-danger">*</span>
            }
        </label>
    }

    <div class="input-group">
        <input class="form-control"
               type="@InputType"
               value="@Value"
               @oninput="OnInput"
               @onkeydown="CheckCapsLock"
               autocomplete="@Autocomplete" />

        <AppButton Type="button"
                   ButtonClass="btn btn-outline-secondary"
                   OnClick="ToggleVisibility">
            <i class="bi @(ShowPassword ? "bi-eye-slash" : "bi-eye")"></i>
        </AppButton>
    </div>

    @if (ShowCapsLock)
    {
        <small class="text-warning">⚠ Caps Lock is ON</small>
    }

    @* @if (ShowStrength) *@
    @* { *@
    @*     <div class="progress mt-2" style="height:6px;"> *@
    @*         <div class="progress-bar @StrengthClass" *@
    @*              style="width:@StrengthPercent%"> *@
    @*         </div> *@
    @*     </div> *@

    @*     <small class="text-muted">@StrengthText</small> *@
    @* } *@

    @if (ValidationExpression != null)
    {
        <ValidationMessage For="ValidationExpression" />
    }
</div>

@code {
    /* PARAMETERS */
    [Parameter] public string? Label { get; set; }
    [Parameter] public bool IsRequired { get; set; }
    [Parameter] public bool ShowStrength { get; set; } = true;
    [Parameter] public string Autocomplete { get; set; } = "new-password";

    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }

    [Parameter] public Expression<Func<string?>>? ValidationExpression { get; set; }

    /* INTERNAL */
    private bool ShowPassword;
    private bool ShowCapsLock;

    private string InputType => ShowPassword ? "text" : "password";

    private async Task OnInput(ChangeEventArgs e)
    {
        await ValueChanged.InvokeAsync(e.Value?.ToString());
    }

    private void ToggleVisibility()
    {
        ShowPassword = !ShowPassword;
    }

    private void CheckCapsLock(KeyboardEventArgs e)
    {
        ShowCapsLock = e.GetType().GetProperty("CapsLock") != null;
    }

    /* PASSWORD STRENGTH */
    private int StrengthScore =>
        string.IsNullOrEmpty(Value) ? 0 :
        (Value.Length >= 8 ? 1 : 0) +
        (Value.Any(char.IsUpper) ? 1 : 0) +
        (Value.Any(char.IsLower) ? 1 : 0) +
        (Value.Any(char.IsDigit) ? 1 : 0) +
        (Value.Any(ch => "!@#$%^&*".Contains(ch)) ? 1 : 0);

    private string StrengthPercent => $"{StrengthScore * 20}%";

    private string StrengthClass => StrengthScore switch
    {
        <= 1 => "bg-danger",
        2 => "bg-warning",
        3 => "bg-info",
        _ => "bg-success"
    };

    private string StrengthText => StrengthScore switch
    {
        <= 1 => "Weak password",
        2 => "Fair password",
        3 => "Good password",
        _ => "Strong password"
    };
}
