@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions
@using arna.HRMS.Components.lib.components.ui.Model

<div class="mb-3">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="form-label">@Label</label>
    }

    <select class="form-select"
            value="@Value"
            @onchange="OnChange">
        <option value="">@Placeholder</option>

        @foreach (var item in Options)
        {
            <option value="@item.Value">@item.Text</option>
        }
    </select>

    @if (ValueExpression != null)
    {
        <ValidationMessage For="ValueExpression" />
    }
</div>

@code {
    [CascadingParameter] private EditContext? EditContext { get; set; }

    [Parameter] public string Label { get; set; } = "";
    [Parameter] public string Placeholder { get; set; } = "Select";

    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }

    [Parameter] public Expression<Func<object>>? ValueExpression { get; set; }

    [Parameter] public List<SelectOption> Options { get; set; } = new();

    private FieldIdentifier? _fieldIdentifier;

    protected override void OnParametersSet()
    {
        if (EditContext != null && ValueExpression != null)
            _fieldIdentifier = FieldIdentifier.Create(ValueExpression);
        else
            _fieldIdentifier = null;
    }

    private async Task OnChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(value);

        if (EditContext != null && _fieldIdentifier.HasValue)
        {
            EditContext.NotifyFieldChanged(_fieldIdentifier.Value);
        }
    }
}
