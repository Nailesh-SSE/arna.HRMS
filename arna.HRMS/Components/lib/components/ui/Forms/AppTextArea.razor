@using System.Linq.Expressions
@using Microsoft.AspNetCore.Components.Forms

<div class="mb-3">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="form-label fw-semibold">
            @Label
            @if (IsRequired)
            {
                <span class="text-danger">*</span>
            }
        </label>
    }

    <textarea class="form-control"
              rows="@Rows"
              value="@Value"
              placeholder="@Placeholder"
              readonly="@ReadOnly"
              disabled="@Disabled"
              @onchange="OnChange"
              @attributes="AdditionalAttributes">
    </textarea>

    @if (ValidationExpression != null)
    {
        <ValidationMessage For="ValidationExpression" />
    }
</div>

@code {
    [CascadingParameter] private EditContext? EditContext { get; set; }

    /* ---------------- PARAMETERS ---------------- */

    [Parameter] public string? Label { get; set; }
    [Parameter] public bool IsRequired { get; set; } = false;

    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }

    [Parameter] public string Placeholder { get; set; } = "";
    [Parameter] public int Rows { get; set; } = 3;

    [Parameter] public bool ReadOnly { get; set; } = false;
    [Parameter] public bool Disabled { get; set; } = false;

    [Parameter] public Expression<Func<object>>? ValidationExpression { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    /* ---------------- PRIVATE ---------------- */

    private FieldIdentifier _fieldIdentifier;

    protected override void OnParametersSet()
    {
        if (EditContext != null && ValidationExpression != null)
        {
            _fieldIdentifier = FieldIdentifier.Create(ValidationExpression);
        }
    }

    private async Task OnChange(ChangeEventArgs e)
    {
        if (!ReadOnly && !Disabled)
        {
            await ValueChanged.InvokeAsync(e.Value?.ToString());

            EditContext?.NotifyFieldChanged(_fieldIdentifier);
        }
    }
}
