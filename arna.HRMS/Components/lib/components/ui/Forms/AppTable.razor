@typeparam TItem
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Models.Common.Table

<div class="app-table-wrapper @WrapperClass">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 @TableClass">
            <thead>
                <tr>
                    @foreach (var col in Columns)
                    {
                        <th class="bg-light text-muted text-uppercase small fw-semibold py-3 px-3 border-bottom">
                            @col.Header
                        </th>
                    }
                    @if (ShowActions)
                    {
                        <th class="bg-light text-muted text-uppercase small fw-semibold py-3 px-3 text-center border-0">
                            Action
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (Items == null || Items.Count == 0)
                {
                    <tr>
                        <td colspan="@GetColSpan()" class="text-center py-5">
                            <i class="bi bi-inbox fs-1 d-block mb-2 text-muted opacity-50"></i>
                            <span class="text-muted">No data found</span>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in DisplayItems)
                    {
                        <tr class="@(RowClassFunc?.Invoke(item) ?? "")">
                            @foreach (var col in Columns)
                            {
                                <td class="px-3 py-2">
                                    @* @if (col.CssClassFunc != null)
                                    {
                                        <span class="@col.CssClassFunc(item)">@col.Value(item)</span>
                                    } *@
                                    @if (!string.IsNullOrWhiteSpace(col.CssClass))
                                    {
                                        <span class="@col.CssClass">@col.Value(item)</span>
                                    }
                                    else
                                    {
                                        @col.Value(item)
                                    }
                                </td>
                            }
                            @if (ShowActions)
                            {
                                <td class="text-center px-3 py-2">
                                    <div class="d-inline-flex gap-2">
                                        @if (ActionTemplate != null)
                                        {
                                            @ActionTemplate(item)
                                        }
                                        else
                                        {
                                            <AppButton ButtonClass="btn btn-sm btn-primary"
                                                       OnClick="() => OnEdit.InvokeAsync(item)">
                                                <i class="bi bi-pencil-square"></i>
                                            </AppButton>
                                            <AppButton ButtonClass="btn btn-sm btn-danger"
                                                       OnClick="() => OnDelete.InvokeAsync(item)">
                                                <i class="bi bi-trash"></i>
                                            </AppButton>
                                        }
                                    </div>
                                </td>
                            }
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (EnablePagination && TotalPages > 1)
    {
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 px-3 py-2 bg-light border-top">
            <small class="text-muted">
                Showing @(((currentPage - 1) * PageSize) + 1)–@(Math.Min(currentPage * PageSize, Items.Count))
                of @Items.Count
            </small>
            <nav>
                <ul class="pagination pagination-sm mb-0 gap-1">
                    <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                        <button class="page-link border-0 rounded" @onclick="() => GoToPage(currentPage - 1)">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                    </li>
                    @foreach (var p in GetVisiblePages())
                    {
                        var page = p;
                        <li class="page-item @(page == currentPage ? "active" : "")">
                            @* <button class="page-link border-0 rounded" @onclick="() => GoToPage(page)">@page</button> *@
                        </li>
                    }
                    <li class="page-item @(currentPage >= TotalPages ? "disabled" : "")">
                        <button class="page-link border-0 rounded" @onclick="() => GoToPage(currentPage + 1)">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

@code {
    [Parameter] public List<TItem> Items { get; set; } = new();
    [Parameter] public List<TableColumn<TItem>> Columns { get; set; } = new();
    [Parameter] public EventCallback<TItem> OnEdit { get; set; }
    [Parameter] public EventCallback<TItem> OnDelete { get; set; }
    [Parameter] public bool ShowActions { get; set; } = true;
    [Parameter] public RenderFragment<TItem>? ActionTemplate { get; set; }

    [Parameter] public bool EnablePagination { get; set; } = false;
    [Parameter] public int PageSize { get; set; } = 10;

    [Parameter] public string WrapperClass { get; set; } = "";
    [Parameter] public string TableClass { get; set; } = "";
    [Parameter] public Func<TItem, string>? RowClassFunc { get; set; }

    private int currentPage = 1;

    private List<TItem> DisplayItems => EnablePagination
        ? Items.Skip((currentPage - 1) * PageSize).Take(PageSize).ToList()
        : Items;

    private int TotalPages => EnablePagination && Items.Count > 0
        ? (int)Math.Ceiling(Items.Count / (double)PageSize) : 1;

    protected override void OnParametersSet()
    {
        if (currentPage > TotalPages)
            currentPage = Math.Max(1, TotalPages);
    }

    private void GoToPage(int page)
    {
        if (page >= 1 && page <= TotalPages)
            currentPage = page;
    }

    private IEnumerable<int> GetVisiblePages()
    {
        if (TotalPages <= 5)
            return Enumerable.Range(1, TotalPages);
        var start = Math.Max(1, currentPage - 2);
        var end = Math.Min(TotalPages, start + 4);
        start = Math.Max(1, end - 4);
        return Enumerable.Range(start, end - start + 1);
    }

    private int GetColSpan() => Columns.Count + (ShowActions ? 1 : 0);
}