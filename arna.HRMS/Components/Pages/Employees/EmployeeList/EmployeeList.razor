@page "/employee"

@using arna.HRMS.ClientServices.Common
@using arna.HRMS.ClientServices.Employee
@using arna.HRMS.ClientServices.Auth
@using arna.HRMS.Components.Common
@using arna.HRMS.Components.Common.Table
@using arna.HRMS.Components.Common.Tables
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Models.Common.Table
@using arna.HRMS.Models.DTOs

@inject IEmployeeService EmployeeService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService
@inject IJSRuntime JsRuntime

@inherits AuthenticatedLayoutBase

<FullPageLoader Visible="isLoading" />

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold text-primary">Employees</h3>

        @if (IsAdmin() || IsSuperAdmin())
        {
            <AppButton cssclass="btn btn-success" Text = "Add Employee" OnClick="@(() => NavigateTo("/employee/create"))">
                <i class="bi bi-plus-lg"></i> 
            </AppButton>
        }
    </div>

    <CommonTable TItem="EmployeeDto"
                 Items="employees"
                 Columns="TableSchemas.Employees"
                 OnEdit="EditEmployee"
                 OnDelete="DeleteEmployee"
                 ShowActions="IsAdmin() || IsSuperAdmin()" />

</div>

@code {

    private List<EmployeeDto> employees = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadEmployeesAsync();
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            isLoading = true;

            var result = await EmployeeService.GetEmployeesAsync();

            if (result.IsSuccess && result.Data != null)
            {
                employees = result.Data;
            }
            else
            {
                NotificationService.Error("Failed to load employees");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading employees: {ex.Message}");
            NotificationService.Error("Something went wrong while loading employees");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateTo(string route)
    {
        NavigationManager.NavigateTo(route);
    }

    private void EditEmployee(EmployeeDto employeeDto)
    {
        NavigationManager.NavigateTo($"/employee/edit/{employeeDto.Id}");
    }

    private async Task DeleteEmployee(EmployeeDto employeeDto)
    {
        bool isConfirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            "Are you sure you want to delete this employee?"
        );

        if (!isConfirmed)
            return;

        var result = await EmployeeService.DeleteEmployeeAsync(employeeDto.Id);

        if (!result.IsSuccess)
        {
            NotificationService.Error($"Delete failed ({result.StatusCode}): {result.Message ?? "Unable to delete employee."}");
            return;
        }

        NotificationService.Success("Employee deleted successfully.");
        await LoadEmployeesAsync();
    }
}
