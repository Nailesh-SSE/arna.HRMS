@page "/employee/employeelist"

@using arna.HRMS.ClientServices.Common
@using arna.HRMS.ClientServices.Employee
@using arna.HRMS.Components.Auth
@using arna.HRMS.Components.Common
@using arna.HRMS.Components.Common.Tables
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Models.DTOs

@inject IEmployeeService EmployeeService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

@inherits AuthenticatedLayoutBase

<FullPageLoader Visible="isLoading" />

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold text-primary">Employee Directory</h3>

        @if (IsAdmin() || IsSuperAdmin())
        {
            <button class="btn btn-success"
                    @onclick="@(() => NavigateTo("/employees/create"))">
                <i class="bi bi-plus-lg"></i> Add Employee
            </button>
        }
    </div>

    <AppTable Items="employees"
              Headers="EmployeeTableHeaders.GetHeaders(IsAdmin() || IsSuperAdmin())"
              Row="EmployeeRow"
              HeaderClass="app-grid-header-dark">
    </AppTable>

</div>

@code {

    private List<EmployeeDto> employees = new();
    private bool isLoading = true;

    private RenderFragment<EmployeeDto> EmployeeRow => employee => @<EmployeeListRow Employee="employee"
                     ShowActions="@(IsAdmin() || IsSuperAdmin())"
                     OnEdit="EditEmployee" />;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadEmployeesAsync();
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            isLoading = true;

            var result = await EmployeeService.GetEmployeesAsync();

            if (result.IsSuccess && result.Data != null)
            {
                employees = result.Data;
            }
            else
            {
                NotificationService.Error("Failed to load employees");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading employees: {ex.Message}");
            NotificationService.Error("Something went wrong while loading employees");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateTo(string route)
    {
        NavigationManager.NavigateTo(route);
    }

    private void EditEmployee(int id)
    {
        NavigationManager.NavigateTo($"/employees/edit/{id}");
    }
}
