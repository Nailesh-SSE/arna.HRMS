@page "/profile"

@using Microsoft.AspNetCore.Components.Authorization
@using arna.HRMS.ClientServices
@using arna.HRMS.ClientServices.Department
@using arna.HRMS.ClientServices.Employee
@inject IDepartmentService DepartmentService
@inject IEmployeeService EmployeeService
@inject AuthenticationStateProvider AuthProvider
@using arna.HRMS.Models.DTOs

<style>
    .employee-container {
        padding: 20px;
    }

    .employee-card {
        display: flex;
        border-radius: 10px;
        background: white;
        overflow: hidden;
        border: 1px solid #e1e1e1;
    }

    .details-sidebar {
        width: 260px;
        background: #f8f9fa;
        padding: 25px;
        text-align: center;
    }

    .profile-picture {
        width: 95px;
        height: 95px;
        font-size: 32px;
        background: #343a40;
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: auto;
    }

    .employee-name {
        margin-top: 12px;
        font-weight: 700;
    }

    .detail-sidebar-title {
        margin-top: 20px;
        color: gray;
        font-size: 12px;
    }

    .detail-sidebar-menu {
        list-style: none;
        padding-left: 0;
        margin-top: 10px;
    }

        .detail-sidebar-menu li {
            padding: 6px 0;
            cursor: pointer;
        }

            .detail-sidebar-menu li.active {
                font-weight: bold;
            }

    .main-content {
        flex-grow: 1;
        padding: 30px;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
    }

    .btn-primary {
        background: #007bff;
        color: white;
        padding: 6px 14px;
        border-radius: 4px;
        border: none;
    }

    .btn-outline {
        border: 1px solid #007bff;
        padding: 6px 14px;
        border-radius: 4px;
        color: #007bff;
        background: white;
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 22px;
        margin-top: 30px;
    }

    .detail-box label {
        font-size: 11px;
        text-transform: uppercase;
        color: gray;
        letter-spacing: 0.5px;
    }

    .detail-box div {
        font-size: 15px;
        font-weight: 500;
    }

    .status-active {
        color: white;
        background: #28a745;
        padding: 3px 10px;
        border-radius: 5px;
    }

    .status-inactive {
        color: white;
        background: #dc3545;
        padding: 3px 10px;
        border-radius: 5px;
    }
</style>

<div class="employee-container">

    @if (employee != null)
    {
        <div class="employee-card shadow">

            <!-- SIDEBAR -->
            <div class="details-sidebar">

                <div class="profile-picture">
                    @employee.FirstName[0]@employee.LastName[0]
                </div>

                <h3 class="employee-name">@employee.FirstName @employee.LastName</h3>

                <p class="text-muted">@employee.Position</p>
                <p class="text-muted">@employee.DepartmentName</p>

                <p class="fw-bold">ID: @employee.EmployeeNumber</p>

                <a href="mailto:@employee.Email">@employee.Email</a>

                <hr />

                <h6 class="detail-sidebar-title">PROFILE</h6>
                <ul class="detail-sidebar-menu">
                    <li class="active">Overview</li>
                    <li>Personal</li>
                    <li>Employment</li>
                    <li>Documents</li>
                </ul>

            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">

                @* <div class="header-section">
                    <h2>Overview</h2>

                    <div>
                        <button class="btn-outline me-2">View Personal Details</button>
                        <button class="btn-primary">Download</button>
                    </div>
                </div> *@

                <div class="details-grid">

                    <div class="detail-box">
                        <label>Employee ID</label>
                        <div>@employee.EmployeeNumber</div>
                    </div>

                    <div class="detail-box">
                        <label>Full Name</label>
                        <div>@employee.FirstName @employee.LastName</div>
                    </div>

                    <div class="detail-box">
                        <label>Email</label>
                        <div>@employee.Email</div>
                    </div>

                    <div class="detail-box">
                        <label>Company</label>
                        <div>Arna Technosoft</div>
                    </div>

                    <div class="detail-box">
                        <label>Department</label>
                        <div>@employee.DepartmentName</div>
                    </div>

                    <div class="detail-box">
                        <label>Position</label>
                        <div>@employee.Position</div>
                    </div>

                    <div class="detail-box">
                        <label>Manager</label>
                        <div>@employee.ManagerFullName</div>
                    </div>

                    <div class="detail-box">
                        <label>Date Of Birth</label>
                        <div>@employee.DateOfBirth.ToShortDateString()</div>
                    </div>

                    <div class="detail-box">
                        <label>Department Code</label>
                        <div>@employee.DepartmentCode</div>
                    </div>

                    <div class="detail-box">
                        <label>Phone Number</label>
                        <div>@employee.PhoneNumber</div>
                    </div>

                    <div class="detail-box">
                        <label>Hire Date</label>
                        <div>@employee.HireDate.ToShortDateString()</div>
                    </div>

                    <div class="detail-box">
                        <label>Created At</label>
                        <div>@employee.CreatedAt.ToShortDateString()</div>
                    </div>

                    <div class="detail-box">
                        <label>Experience</label>
                        <div>@experienceString</div>
                    </div>

                    <div class="detail-box">
                        <label>Status</label>
                        <div>
                            @if (employee.IsActive)
                            {
                                <span class="status-active">Active</span>
                            }
                            else
                            {
                                <span class="status-inactive">Inactive</span>
                            }
                        </div>
                    </div>

                </div>

            </div>
        </div>
    }
    else
    {
        <div>Loading...</div>
    }

</div>

@code {

    private EmployeeDto? employee;
    private string experienceString = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var employeeIdClaim = user.FindFirst("EmployeeId")?.Value;
        if (!int.TryParse(employeeIdClaim, out var employeeId))
            return;

        var employeeResult = await EmployeeService.GetEmployeeByIdAsync(employeeId);

        if (!employeeResult.IsSuccess || employeeResult.Data == null)
            return;

        employee = employeeResult.Data;

        var deptResult = await DepartmentService.GetDepartmentByIdAsync(employee.DepartmentId);
        if (deptResult != null)
        {
            employee.DepartmentName = deptResult.Data.Name;
            employee.DepartmentCode = deptResult.Data.Code;
        }

        if (employee.ManagerId.HasValue)
        {
            var employeesResult = await EmployeeService.GetEmployeesAsync();

            var manager = employeesResult.Data?.FirstOrDefault(e => e.Id == employee.ManagerId.Value);

            if (manager != null)
            {
                employee.ManagerFullName = $"{manager.FirstName} {manager.LastName}";
            }
        }

        CalculateExperience();
    }

    private void CalculateExperience()
    {
        if (employee == null) return;

        var doj = employee.HireDate;
        var today = DateTime.Today;

        var years = today.Year - doj.Year;
        var months = today.Month - doj.Month;
        var days = today.Day - doj.Day;

        if (days < 0)
        {
            months--;
            days += DateTime.DaysInMonth(today.Year, today.Month == 1 ? 12 : today.Month - 1);
        }

        if (months < 0)
        {
            years--;
            months += 12;
        }

        experienceString = $"{years} Y {months} M {days} D";
    }
}
