@page "/profile"

@using arna.HRMS.ClientServices
@using arna.HRMS.ClientServices.Department
@using arna.HRMS.ClientServices.Employee
@using arna.HRMS.Components.Auth
@using arna.HRMS.Components.Common
@using arna.HRMS.Models.DTOs

@inject IDepartmentService DepartmentService
@inject IEmployeeService EmployeeService
@inject NavigationManager NavigationManager
@inherits AuthenticatedLayoutBase


<div class="employee-container">

    @if (employee != null)
    {
        <div class="employee-card shadow">

            <!-- SIDEBAR -->
            <div class="details-sidebar">

                <div class="profile-picture">
                    @GetInitials()
                </div>

                <h3 class="employee-name">@employee.FirstName @employee.LastName</h3>

                <p class="text-muted">@employee.Position</p>
                <p class="text-muted">@employee.DepartmentName</p>

                <p class="fw-bold">ID: @employee.EmployeeNumber</p>

                <a href="mailto:@employee.Email">@employee.Email</a>

                <hr />

                <h6 class="detail-sidebar-title">PROFILE</h6>
                <ul class="detail-sidebar-menu">
                    <li class="active">Overview</li>
                    <li>Personal</li>
                    <li>Employment</li>
                    <li>Documents</li>
                </ul>

            </div>

            <!-- MAIN CONTENT -->
            <div class="main-content">

                <div class="details-grid">

                    <div class="detail-box">
                        <label>Employee ID</label>
                        <div>@employee.EmployeeNumber</div>
                    </div>

                    <div class="detail-box">
                        <label>Full Name</label>
                        <div>@employee.FirstName @employee.LastName</div>
                    </div>

                    <div class="detail-box">
                        <label>Email</label>
                        <div>@employee.Email</div>
                    </div>

                    <div class="detail-box">
                        <label>Company</label>
                        <div>Arna Technosoft</div>
                    </div>

                    <div class="detail-box">
                        <label>Department</label>
                        <div>@employee.DepartmentName</div>
                    </div>

                    <div class="detail-box">
                        <label>Position</label>
                        <div>@employee.Position</div>
                    </div>

                    <div class="detail-box">
                        <label>Manager</label>
                        <div>@employee.ManagerFullName</div>
                    </div>

                    <div class="detail-box">
                        <label>Date Of Birth</label>
                        <div>@employee.DateOfBirth.ToShortDateString()</div>
                    </div>

                    <div class="detail-box">
                        <label>Department Code</label>
                        <div>@employee.DepartmentCode</div>
                    </div>

                    <div class="detail-box">
                        <label>Phone Number</label>
                        <div>@employee.PhoneNumber</div>
                    </div>

                    <div class="detail-box">
                        <label>Hire Date</label>
                        <div>@employee.HireDate.ToShortDateString()</div>
                    </div>

                    <div class="detail-box">
                        <label>Created At</label>
                        <div>@employee.CreatedBy.ToShortDateString()</div>
                    </div>

                    <div class="detail-box">
                        <label>Experience</label>
                        <div>@experienceString</div>
                    </div>

                    <div class="detail-box">
                        <label>Status</label>
                        <div>
                            @if (employee.IsActive)
                            {
                                <span class="status-active">Active</span>
                            }
                            else
                            {
                                <span class="status-inactive">Inactive</span>
                            }
                        </div>
                    </div>

                </div>

            </div>
        </div>
    }
    else
    {
        <FullPageLoader />
    }

</div>

@code {
    private EmployeeDto? employee;
    private string experienceString = "";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var employeeId = GetEmployeeId();
        if (employeeId == 0)
            return;

        var employeeResult = await EmployeeService.GetEmployeeByIdAsync(employeeId);
        if (!employeeResult.IsSuccess || employeeResult.Data == null)
            return;

        employee = employeeResult.Data;

        var deptResult = await DepartmentService.GetDepartmentByIdAsync(employee.DepartmentId!.Value);
        if (deptResult?.Data != null)
        {
            employee.DepartmentName = deptResult.Data.Name;
            employee.DepartmentCode = deptResult.Data.Code;
        }

        if (employee.ManagerId.HasValue)
        {
            var employeesResult = await EmployeeService.GetEmployeesAsync();
            var manager = employeesResult.Data?
                .FirstOrDefault(e => e.Id == employee.ManagerId.Value);

            if (manager != null)
                employee.ManagerFullName = $"{manager.FirstName} {manager.LastName}";
        }

        CalculateExperience();

        StateHasChanged();
    }

    private void CalculateExperience()
    {
        if (employee?.HireDate == null)
        {
            experienceString = "N/A";
            return;
        }

        var doj = employee.HireDate;
        var today = DateTime.Today;

        var years = today.Year - doj.Year;
        var months = today.Month - doj.Month;

        if (today.Day < doj.Day)
            months--;

        if (months < 0)
        {
            years--;
            months += 12;
        }

        experienceString = $"{Math.Max(years, 0)} Y {Math.Max(months, 0)} M";
    }

    private string GetInitials()
    {
        var f = employee?.FirstName?.FirstOrDefault();
        var l = employee?.LastName?.FirstOrDefault();
        return $"{f}{l}".ToUpper();
    }
}
