@page "/employees/create"
@page "/employees/edit/{Id:int}"
@attribute [Authorize(Roles = $"{nameof(UserRole.SuperAdmin)},{nameof(UserRole.Admin)}")]
@using Microsoft.AspNetCore.Authorization
@using arna.HRMS.ClientServices
@using arna.HRMS.ClientServices.Common
@using arna.HRMS.ClientServices.Department
@using arna.HRMS.ClientServices.Employee
@using arna.HRMS.Models.DTOs
@using arna.HRMS.Models.Enums
@using arna.HRMS.Models.ViewModels
@using arna.HRMS.Components.Common

@inject IEmployeeService EmployeeService
@inject IDepartmentService DepartmentService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService



<FullPageLoader Visible="isLoading" />

<div class="container py-4">

    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                @(IsEditMode ? "Edit Employee" : "Create Employee")
            </h5>
        </div>

        <div class="card-body p-4">

            @if (!isLoading)
            {
                <EditForm EditContext="@editContext" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />

                    <div class="card employee-form-card">
                        <div class="card-body p-4">

                            <!-- HEADER -->
                            <div class="mb-4">
                                <h4 class="fw-semibold mb-1">
                                    @(IsEditMode ? "Edit Employee" : "Add New Employee")
                                </h4>
                                <p class="text-muted mt-3">
                                    Fill in the employee details below
                                </p>
                            </div>

                            <!-- PERSONAL INFORMATION -->
                            <div class="form-section">
                                <div class="section-title">
                                    <span>Personal Information</span>
                                </div>

                                <div class="row g-3 mt-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">First Name</label>
                                        <InputText class="form-control" @bind-Value="employee.FirstName" />
                                        <ValidationMessage For="@(() => employee.FirstName)" />
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Last Name</label>
                                        <InputText class="form-control" @bind-Value="employee.LastName" />
                                        <ValidationMessage For="@(() => employee.LastName)" />
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Email</label>
                                        <InputText class="form-control" @bind-Value="employee.Email" />
                                        <ValidationMessage For="@(() => employee.Email)" />
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Phone Number</label>
                                        <InputText class="form-control" @bind-Value="employee.PhoneNumber" />
                                        <ValidationMessage For="@(() => employee.PhoneNumber)" />
                                    </div>
                                </div>
                            </div>

                            <!-- JOB DETAILS -->
                            <div class="form-section mt-5">
                                <div class="section-title">
                                    <span>Job Details</span>
                                </div>

                                <div class="row g-3 mt-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Position</label>
                                        <InputText class="form-control" @bind-Value="employee.Position" />
                                        <ValidationMessage For="@(() => employee.Position)" />
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Salary</label>
                                        <InputNumber class="form-control" @bind-Value="employee.Salary" />
                                        <ValidationMessage For="@(() => employee.Salary)" />
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Department</label>
                                        <InputSelect class="form-select" @bind-Value="employee.DepartmentId">
                                            <option value="">Select Department</option>
                                            @foreach (var dept in departments)
                                            {
                                                <option value="@dept.Id">@dept.Name</option>
                                            }
                                        </InputSelect>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Manager</label>
                                        <InputSelect class="form-select" @bind-Value="employee.ManagerId">
                                            <option value="">Select Manager</option>
                                            @foreach (var mgr in managers)
                                            {
                                                <option value="@mgr.Id">
                                                    @mgr.FirstName @mgr.LastName
                                                </option>
                                            }
                                        </InputSelect>
                                    </div>
                                </div>
                            </div>

                            <!-- OTHER DETAILS -->
                            <div class="form-section mt-5">
                                <div class="section-title">
                                    <span>Other Details</span>
                                </div>

                                <div class="row g-3 mt-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Date of Birth</label>
                                        <InputDate class="form-control" @bind-Value="employee.DateOfBirth" />
                                        <ValidationMessage For="@(() => employee.DateOfBirth)" />
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Hire Date</label>
                                        <InputDate class="form-control" @bind-Value="employee.HireDate" />
                                        <ValidationMessage For="@(() => employee.HireDate)" />
                                    </div>
                                </div>
                            </div>

                            <!-- ACTION BUTTONS -->
                            <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                                <button type="button"
                                        class="btn btn-outline-secondary px-4"
                                        @onclick="GoBack">
                                    Back
                                </button>

                                <button type="submit"
                                        class="btn btn-primary px-5">
                                    @(IsEditMode ? "Update Employee" : "Save Employee")
                                </button>
                            </div>

                        </div>
                    </div>
                </EditForm>
            }
        </div>
    </div>

</div>

@code {
    [Parameter] public int? Id { get; set; }

    private EmployeeDto employee = new();
    private EditContext editContext;

    private bool isLoading = true;
    private bool IsEditMode => Id.HasValue;

    private List<DepartmentDto> departments = new();
    private List<EmployeeDto> managers = new();

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;

        // Load departments
        var deptResult = await DepartmentService.GetDepartmentsAsync();
        if (deptResult.IsSuccess && deptResult.Data != null)
        {
            departments = deptResult.Data.ToList();
        }
        else
        {
            departments = new();
        }

        // Load managers
        var empResult = await EmployeeService.GetEmployeesAsync();
        if (empResult.IsSuccess && empResult.Data != null)
        {
            managers = empResult.Data.ToList();
        }
        else
        {
            managers = new();
        }

        if (IsEditMode)
        {
            var result = await EmployeeService.GetEmployeeByIdAsync(Id!.Value);

            if (result.IsSuccess && result.Data != null)
            {
                employee = result.Data;
            }
            else
            {
                NotificationService.Error($"Employee not found ({result.StatusCode}): {result.Message ?? "Employee not found."}");
                NavigationManager.NavigateTo("/employee/employeelist");
                return;
            }
        }

        editContext = new EditContext(employee);
        isLoading = false;
    }

    private async Task HandleValidSubmit()
    {
        if (IsEditMode)
        {
            var result = await EmployeeService.UpdateEmployeeAsync(Id!.Value, employee);

            if (!result.IsSuccess)
            {
                NotificationService.Error($"Update failed ({result.StatusCode}): {result.Message ?? "Unable to update employee."}");
                return;
            }

            NotificationService.Success("Employee updated successfully.");
        }
        else
        {
            var result = await EmployeeService.CreateEmployeeAsync(employee);

            if (!result.IsSuccess)
            {
                NotificationService.Error($"Create failed ({result.StatusCode}): {result.Message ?? "Unable to create employee."}");
                return;
            }

            NotificationService.Success("Employee created successfully.");
        }

        NavigationManager.NavigateTo("/employee/employeelist");
    }

    private void GoBack() => NavigationManager.NavigateTo("/employee/employeelist");
}