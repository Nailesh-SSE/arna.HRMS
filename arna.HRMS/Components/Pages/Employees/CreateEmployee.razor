@page "/employees/create"
@page "/employees/edit/{Id:int}"

@using arna.HRMS.ClientServices.Common
@using arna.HRMS.ClientServices.Employee
@using arna.HRMS.ClientServices
@using arna.HRMS.Models.DTOs
@using arna.HRMS.Models.ViewModels

@inject IEmployeeService EmployeeService
@inject IDepartmentService DepartmentService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<div class="container py-4">

    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                @(IsEditMode ? "Edit Employee" : "Create Employee")
            </h5>
        </div>

        <div class="card-body p-4">

            @if (isLoading)
            {
                <p><em>Loading...</em></p>
            }
            else
            {
                <EditForm EditContext="@editContext" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />

                    <!-- PERSONAL INFORMATION -->
                    <h6 class="border-bottom pb-2 mb-3 text-secondary">Personal Information</h6>

                    <div class="row g-4">
                        <div class="col-md-4">
                            <label class="form-label">First Name</label>
                            <InputText class="form-control" @bind-Value="employee.FirstName" autocomplete="off" />
                            <ValidationMessage For="@(() => employee.FirstName)" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Last Name</label>
                            <InputText class="form-control" @bind-Value="employee.LastName" autocomplete="off" />
                            <ValidationMessage For="@(() => employee.LastName)" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <InputText class="form-control" @bind-Value="employee.Email" autocomplete="off" />
                            <ValidationMessage For="@(() => employee.Email)" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Phone Number</label>
                            <InputText class="form-control" @bind-Value="employee.PhoneNumber" autocomplete="off" />
                            <ValidationMessage For="@(() => employee.PhoneNumber)" />
                        </div>
                    </div>

                    <!-- JOB DETAILS -->
                    <h6 class="border-bottom pb-2 mt-4 mb-3 text-secondary">Job Details</h6>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label">Position</label>
                            <InputText class="form-control" @bind-Value="employee.Position" autocomplete="off" />
                            <ValidationMessage For="@(() => employee.Position)" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Salary</label>
                            <InputNumber class="form-control" @bind-Value="employee.Salary" autocomplete="off" />
                            <ValidationMessage For="@(() => employee.Salary)" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Department</label>
                            <InputSelect class="form-select" @bind-Value="employee.DepartmentId">
                                <option value="">-- Select Department --</option>
                                @foreach (var dept in departments)
                                {
                                    <option value="@dept.Id">@dept.DepartmentName</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Manager</label>
                            <InputSelect class="form-select" @bind-Value="employee.ManagerId">
                                <option value="">-- No Manager --</option>
                                @foreach (var mgr in managers)
                                {
                                    <option value="@mgr.Id">@mgr.FirstName @mgr.LastName</option>
                                }
                            </InputSelect>
                        </div>
                    </div>

                    <!-- OTHER DETAILS -->
                    <h6 class="border-bottom pb-2 mt-4 mb-3 text-secondary">Other Details</h6>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label">Date of Birth</label>
                            <InputDate class="form-control" @bind-Value="employee.DateOfBirth" autocomplete="off" />
                            <ValidationMessage For="@(() => employee.DateOfBirth)" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Hire Date</label>
                            <InputDate class="form-control" @bind-Value="employee.HireDate" autocomplete="off" />
                            <ValidationMessage For="@(() => employee.HireDate)" />
                        </div>
                    </div>

                    <div class="mt-5 d-flex justify-content-end gap-3">
                        <button type="button" class="btn btn-outline-secondary" @onclick="GoBack">
                            Back
                        </button>

                        <button type="submit" class="btn btn-primary px-4">
                            @(IsEditMode ? "Update" : "Save")
                        </button>
                    </div>

                </EditForm>
            }
        </div>
    </div>

</div>

@code {
    [Parameter] public int? Id { get; set; }

    private EmployeeDto employee = new();
    private EditContext editContext;

    private bool isLoading = true;
    private bool IsEditMode => Id.HasValue;

    private List<DepartmentViewModel> departments = new();
    private List<EmployeeDto> managers = new();

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;

        // Load departments
        var deptResult = await DepartmentService.GetDepartmentsAsync();
        departments = deptResult?
            .Select(d => new DepartmentViewModel
                {
                    Id = d.Id,
                    DepartmentName = d.Name
                })
            .ToList() ?? new();

        // Load managers
        var empResult = await EmployeeService.GetEmployeesAsync();
        managers = empResult.Data?.ToList() ?? new();

        if (IsEditMode)
        {
            var result = await EmployeeService.GetEmployeeByIdAsync(Id!.Value);

            if (result.IsSuccess && result.Data != null)
            {
                employee = result.Data;
            }
            else
            {
                NotificationService.Error($"Employee not found ({result.StatusCode}): {result.Message ?? "Employee not found."}");
                NavigationManager.NavigateTo("/employee/employeelist");
                return;
            }
        }

        editContext = new EditContext(employee);
        isLoading = false;
    }

    private async Task HandleValidSubmit()
    {
        if (IsEditMode)
        {
            var result = await EmployeeService.UpdateEmployeeAsync(Id!.Value, employee);

            if (!result.IsSuccess)
            {
                NotificationService.Error($"Update failed ({result.StatusCode}): {result.Message ?? "Unable to update employee."}");
                return;
            }

            NotificationService.Success("Employee updated successfully.");
        }
        else
        {
            var result = await EmployeeService.CreateEmployeeAsync(employee);

            if (!result.IsSuccess)
            {
                NotificationService.Error($"Create failed ({result.StatusCode}): {result.Message ?? "Unable to create employee."}");
                return;
            }

            NotificationService.Success("Employee created successfully.");
        }

        NavigationManager.NavigateTo("/employee/employeelist");
    }

    private void GoBack() => NavigationManager.NavigateTo("/employee/employeelist");
}