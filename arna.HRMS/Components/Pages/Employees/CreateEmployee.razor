@page "/createemployee"
@page "/employees/edit/{Id:int}"

@using arna.HRMS.ClientServices.Employee
@using arna.HRMS.Models.DTOs
@using arna.HRMS.Models.ViewModels
@using arna.HRMS.ClientServices
@inject IEmployeeService EmployeeService
@inject IDepartmentService DepartmentService
@inject NavigationManager NavigationManager

<div class="container py-4">

    <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">@((IsEditMode ? "Edit Employee" : "Create New Employee"))</h5>
        </div>

        <div class="card-body p-4">
            <EditForm EditContext="@editcontext" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />

                <!-- Personal Information -->
                <h6 class="border-bottom pb-2 mb-3 text-secondary">Personal Information</h6>

                <div class="row g-4">

                    <div class="col-md-4">
                        <label class="form-label">Employee Number</label>
                        <InputText class="form-control" @bind-Value="employee.EmployeeNumber" />
                        <ValidationMessage For="@(() => employee.EmployeeNumber)" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">First Name</label>
                        <InputText class="form-control" @bind-Value="employee.FirstName" />
                        <ValidationMessage For="@(() => employee.FirstName)" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Last Name</label>
                        <InputText class="form-control" @bind-Value="employee.LastName" />
                        <ValidationMessage For="@(() => employee.LastName)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="employee.Email" />
                        <ValidationMessage For="@(() => employee.Email)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Phone Number</label>
                        <InputText class="form-control" @bind-Value="employee.PhoneNumber" />
                        <ValidationMessage For="@(() => employee.PhoneNumber)" />
                    </div>

                </div>


                <!-- Job Details -->
                <h6 class="border-bottom pb-2 mt-4 mb-3 text-secondary">Job Details</h6>

                <div class="row g-4">

                    <div class="col-md-6">
                        <label class="form-label">Position</label>
                        <InputText class="form-control" @bind-Value="employee.Position" />
                        <ValidationMessage For="@(() => employee.Position)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Salary</label>
                        <InputNumber class="form-control" @bind-Value="employee.Salary" />
                        <ValidationMessage For="@(() => employee.Salary)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Department</label>
                        <InputSelect class="form-select" @bind-Value="employee.DepartmentId">
                            <option value="">-- Select Department --</option>
                            @foreach (var dept in departments)
                            {
                                <option value="@dept.Id">@dept.DepartmentName</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Manager</label>
                        <InputSelect class="form-select" @bind-Value="employee.ManagerId">
                            <option value="">-- No Manager --</option>
                            @foreach (var m in managers)
                            {
                                <option value="@m.Id">@m.FirstName @m.LastName</option>
                            }
                        </InputSelect>
                    </div>

                </div>


                <!-- Additional Info -->
                <h6 class="border-bottom pb-2 mt-4 mb-3 text-secondary">Other Details</h6>

                <div class="row g-4">

                    <div class="col-md-6">
                        <label class="form-label">Date of Birth</label>
                        <InputDate class="form-control" @bind-Value="employee.DateOfBirth" />
                        <ValidationMessage For="@(() => employee.DateOfBirth)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Hire Date</label>
                        <InputDate class="form-control" @bind-Value="employee.HireDate" />
                        <ValidationMessage For="@(() => employee.HireDate)" />
                    </div>

                    @* <div class="col-md-6">
                        <label class="form-label">Password</label>
                        <InputText type="password" class="form-control" @bind-Value="employee.Password" />
                        <ValidationMessage For="@(() => employee.Password)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Primary Role</label>
                        <InputNumber class="form-control" @bind-Value="employee.PrimaryRole" />
                    </div> *@

                </div>

                <div class="mt-5 d-flex justify-content-end gap-3">
                    <button class="btn btn-outline-secondary" @onclick="GoBack">
                        Cancel
                    </button>
                    <button class="btn btn-primary px-4" type="submit">
                        @(IsEditMode ? "Update Employee" : "Save Employee")
                    </button>
                </div>

            </EditForm>
        </div>
    </div>

</div>
@code {
    [Parameter] public int? Id { get; set; }

    private EditContext editcontext;
    private EmployeeViewModel employee = new();
    private List<DepartmentViewModel> departments = new();
    private List<EmployeeViewModel> managers = new();
    private bool IsEditMode => Id.HasValue;

    protected override async Task OnInitializedAsync()
    {
        editcontext = new EditContext(employee);

        var data = await DepartmentService.GetDepartmentsAsync();
        var employeeData = await EmployeeService.GetEmployeesAsync();

        departments = data.Select(s => new DepartmentViewModel
        {
            Id = s.Id,
            DepartmentName = s.Name
        }).ToList();

        managers = employeeData.Select(s => new EmployeeViewModel
        {
            Id = s.Id,
            FirstName = s.FirstName,
            LastName = s.LastName
        }).ToList();

        if (IsEditMode)
        {
            var existing = await EmployeeService.GetEmployeeByIdAsync(Id.Value);

            if (existing != null)
            {
                employee.EmployeeNumber = existing.EmployeeNumber;
                employee.FirstName = existing.FirstName;
                employee.LastName = existing.LastName;
                employee.Email = existing.Email;
                employee.PhoneNumber = existing.PhoneNumber;
                employee.Position = existing.Position;
                employee.Salary = existing.Salary;
                employee.DateOfBirth = existing.DateOfBirth;
                employee.HireDate = existing.HireDate;
                employee.DepartmentId = existing.DepartmentId;
                employee.ManagerId = existing.ManagerId;
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        var dto = new EmployeeDto
        {
            Id = Id ?? 0,
            EmployeeNumber = employee.EmployeeNumber,
            FirstName = employee.FirstName,
            LastName = employee.LastName,
            Email = employee.Email,
            PhoneNumber = employee.PhoneNumber,
            Position = employee.Position,
            Salary = employee.Salary,
            DateOfBirth = employee.DateOfBirth,
            HireDate = employee.HireDate,
            DepartmentId = employee.DepartmentId,
            ManagerId = employee.ManagerId
        };

        if (IsEditMode)
        {
            await EmployeeService.UpdateEmployeeAsync(Id.Value, dto);
        }
        else
        {
            await EmployeeService.CreateEmployeeAsync(dto);
        }

        NavigationManager.NavigateTo("/employees/employeelist");
    }

    private void GoBack() => NavigationManager.NavigateTo("/employees/employeelist");
}