@using arna.HRMS.ClientServices.Admin.Employee
@using arna.HRMS.ClientServices.Client.AttendanceRequest
@using arna.HRMS.ClientServices.Common
@using arna.HRMS.Components.Loader
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Components.lib.components.ui.CommonComponent
@using arna.HRMS.Components.lib.components.ui.Model
@using arna.HRMS.Models.Common
@using arna.HRMS.Models.Common.Table
@using arna.HRMS.Models.Enums
@using arna.HRMS.Models.State.Attendance
@using arna.HRMS.Models.ViewModels.Attendance

@inject AttendanceState State
@inject IAttendanceRequestService AttendanceRequestService
@inject IEmployeeService EmployeeService
@inject NotificationService NotificationService
@inject IJSRuntime JsRuntime

<Loader Visible="_isLoading" Message="@_loadingMessage" />

@if (!_isLoading)
{
    <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center
                    justify-content-between gap-2 gap-sm-3 mb-3 mb-md-4">
        <div class="d-flex align-items-start gap-2">
            <span class="bg-warning bg-opacity-10 text-warning rounded-2 p-2
                             header-icon-box flex-shrink-0">
                <i class="bi bi-inbox-fill fs-5"></i>
            </span>
            <div>
                <h5 class="fw-bold mb-0 fs-6 fs-md-5">Attendance Requests</h5>
                <p class="text-muted mb-0 small d-none d-sm-block">
                    Review and manage employee attendance correction requests
                </p>
            </div>
        </div>

        @if (HasActiveFilters)
        {
            <button class="btn btn-outline-secondary btn-sm rounded-pill px-3 w-100 w-sm-auto"
                    @onclick="ClearFilters">
                <i class="bi bi-x-lg me-1"></i>Clear All Filters
            </button>
        }
    </div>

    <!-- ═══════════ STATUS SUMMARY CARDS ═══════════ -->
    <div class="row g-2 g-md-3 mb-3 mb-md-4">
        @foreach (var stat in StatCards)
        {
            <div class="col-6 col-md-3">
                <div class="card border-0 shadow-sm rounded-3 stat-card h-100
                                    @(IsStatActive(stat.Status) ? stat.ActiveClass : "")"
                     role="button"
                     @onclick="() => FilterByStatus(stat.Status)">
                    <div class="card-body text-center py-2 py-md-3 px-2">
                        <div class="stat-icon @stat.BgClass mx-auto">
                            <i class="bi @stat.Icon @stat.TextClass"></i>
                        </div>
                        <div class="fs-4 fw-bold @stat.TextClass">@stat.Count</div>
                        <small class="text-muted fw-medium text-uppercase stat-label">
                            @stat.Label
                        </small>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- ═══════════ FILTER BAR ═══════════ -->
    <div class="card border-0 shadow-sm rounded-3 mb-3 mb-md-4">
        <div class="card-body py-2 px-2 px-md-3">
            <div class="row align-items-center g-2">

                <div class="col-auto">
                    <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill
                                     px-2 px-md-3 py-2">
                        <i class="bi bi-funnel-fill me-0 me-md-1"></i>
                        <span class="d-none d-md-inline">Filters</span>
                    </span>
                </div>

                <div class="col">
                    <SearchEmployee Employees="Employees"
                                    SelectedValue="@GetEmployeeValue()"
                                    OnChanged="OnEmployeeChanged"
                                    OnNameChanged="OnEmployeeNameChanged" />
                </div>

                @if (HasActiveFilters)
                {
                    <div class="col-12 col-md-auto">
                        <div class="d-flex align-items-center gap-1 gap-md-2 flex-wrap">
                            @if (_statusFilter.HasValue)
                            {
                                <span class="badge bg-light text-dark border rounded-pill
                                                         px-2 px-md-3 py-1 py-md-2 small">
                                    <span class="d-none d-sm-inline">Status: </span>
                                    <strong>@_statusFilter</strong>
                                    <button type="button"
                                            class="btn-close btn-close-sm ms-1"
                                            style="font-size: 0.5rem;"
                                            @onclick="() => FilterByStatus(null)">
                                    </button>
                                </span>
                            }
                            @if (State.SelectedEmployeeId.HasValue)
                            {
                                <span class="badge bg-light text-dark border rounded-pill
                                                         px-2 px-md-3 py-1 py-md-2 small">
                                    <span class="d-none d-sm-inline">Employee: </span>
                                    <strong>
                                        @TruncateName(_selectedEmployeeName ?? "Selected", 15)
                                    </strong>
                                    <button type="button"
                                            class="btn-close btn-close-sm ms-1"
                                            style="font-size: 0.5rem;"
                                            @onclick="ClearEmployeeFilter">
                                    </button>
                                </span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- ═══════════ TABLE ═══════════ -->
    <div class="card border-0 shadow-sm rounded-3">

        <div class="card-header bg-white border-bottom py-2 py-md-3 px-2 px-md-3">
            <div class="d-flex align-items-center justify-content-between">
                <h6 class="fw-semibold mb-0 small">
                    <i class="bi bi-table text-primary me-1 me-md-2"></i>
                    <span class="d-none d-sm-inline">Request Details</span>
                    <span class="d-sm-none">Requests</span>
                </h6>
                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill
                                 px-2 px-md-3 small">
                    @FilteredRequests.Count
                    <span class="d-none d-sm-inline">requests</span>
                </span>
            </div>
        </div>

        <div class="card-body p-0">
            @if (!FilteredRequests.Any())
            {
                <div class="text-center py-4 py-md-5 px-3">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center
                                        justify-content-center mb-2 mb-md-3 empty-icon-circle">
                        <i class="bi bi-inbox fs-2 text-muted opacity-50"></i>
                    </div>
                    <h6 class="fw-semibold text-muted mb-1 fs-6">No Requests Found</h6>
                    <p class="text-muted small mb-2 mb-md-3 mx-auto empty-text">
                        @if (HasActiveFilters)
                        {
                            <span>No requests match your current filters.</span>
                        }
                        else
                        {
                            <span>There are no attendance requests yet.</span>
                        }
                    </p>
                    @if (HasActiveFilters)
                    {
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-3 px-md-4"
                                @onclick="ClearFilters">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Filters
                        </button>
                    }
                </div>
            }
            else
            {
                <div class="request-scroll-area">
                    <AppTable TItem="AttendanceRequestViewModel"
                              Items="FilteredRequests"
                              Columns="TableSchemas.AttendanceRequest"
                              EnablePagination="true"
                              PageSize="10"
                              WrapperClass="att-list-table">

                        <ActionTemplate Context="req">
                            @if (req.StatusId != Status.Cancelled)
                            {
                                <div class="d-flex align-items-center gap-1 gap-md-2
                                                        justify-content-center">
                                    <button class="action-btn @GetApproveClass(req)"
                                            title="Approve"
                                            disabled="@_isUpdating"
                                            @onclick="() => UpdateStatus(req, Status.Approved)">
                                        <i class="bi bi-check-lg"></i>
                                    </button>

                                    <button class="action-btn @GetRejectClass(req)"
                                            title="Reject"
                                            disabled="@_isUpdating"
                                            @onclick="() => UpdateStatus(req, Status.Rejected)">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            }
                            else
                            {
                                <span class="badge bg-secondary bg-opacity-10 text-secondary
                                                         rounded-pill px-2 px-md-3 small">
                                    <i class="bi bi-slash-circle me-1 d-none d-sm-inline"></i>
                                    Cancelled
                                </span>
                            }
                        </ActionTemplate>

                    </AppTable>
                </div>
            }
        </div>
    </div>
}

@code {

    // ═══════════ PARAMETERS ═══════════

    [Parameter] public EventCallback<int> OnPendingCountChanged { get; set; }

    // ═══════════ STATE ═══════════

    private bool _isLoading;
    private bool _isUpdating;
    private string _loadingMessage = "Loading attendance requests...";

    private List<AttendanceRequestViewModel> _allRequests = new();
    private List<SelectOption> Employees = new();

    private Status? _statusFilter;
    private string? _selectedEmployeeName;
    private string? _selectedEmployeeNumber;

    private int _pendingCount;
    private int _approvedCount;
    private int _rejectedCount;

    // ═══════════ COMPUTED ═══════════

    private bool HasActiveFilters
        => _statusFilter.HasValue || State.SelectedEmployeeId.HasValue;

    private List<AttendanceRequestViewModel> FilteredRequests
        => _allRequests
            .Where(r =>
                (!_statusFilter.HasValue || r.StatusId == _statusFilter) &&
                (!State.SelectedEmployeeId.HasValue ||
                 r.EmployeeId == State.SelectedEmployeeId) &&
                (string.IsNullOrWhiteSpace(_selectedEmployeeName) ||
                 (r.EmployeeName?.Contains(_selectedEmployeeName,
                     StringComparison.OrdinalIgnoreCase) ?? false)))
            .ToList();

    private IEnumerable<StatCardModel> StatCards => new[]
    {
        new StatCardModel(null,            "bi-grid-fill",         "bg-primary bg-opacity-10",
            "text-primary", "active-all",      _allRequests.Count, "All"),
        new StatCardModel(Status.Pending,  "bi-hourglass-split",   "bg-warning bg-opacity-10",
            "text-warning", "active-pending",  _pendingCount,      "Pending"),
        new StatCardModel(Status.Approved, "bi-check-circle-fill", "bg-success bg-opacity-10",
            "text-success", "active-approved", _approvedCount,     "Approved"),
        new StatCardModel(Status.Rejected, "bi-x-circle-fill",     "bg-danger bg-opacity-10",
            "text-danger",  "active-rejected", _rejectedCount,     "Rejected"),
    };

    // ═══════════ LIFECYCLE ═══════════

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;

        try
        {
            await Task.WhenAll(LoadEmployees(), LoadRequests());
        }
        catch (Exception ex)
        {
            NotificationService.Error($"Failed to load data: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ═══════════ DATA ═══════════

    private async Task LoadRequests()
    {
        try
        {
            var result = (State.SelectedEmployeeId, _statusFilter) switch
            {
                (int empId, Status status) =>
                    await AttendanceRequestService.GetAllAsync(empId, status),
                (int empId, null) =>
                    await AttendanceRequestService.GetAllAsync(empId),
                (null, Status status) =>
                    await AttendanceRequestService.GetAllAsync(status),
                _ =>
                    await AttendanceRequestService.GetAllAsync()
            };

            _allRequests = result?.IsSuccess == true
                ? result.Data ?? new()
                : new();

            RecalculateCounts();
            await OnPendingCountChanged.InvokeAsync(_pendingCount);
        }
        catch
        {
            _allRequests = new();
            _pendingCount = _approvedCount = _rejectedCount = 0;
        }
    }

    private async Task LoadEmployees()
    {
        try
        {
            var result = await EmployeeService.GetEmployeesAsync();

            Employees = result?.IsSuccess == true
                ? result.Data
                    .Select(e => new SelectOption
                    {
                        Value = e.Id.ToString(),
                        Text = $"{e.FullName} ({e.EmployeeNumber})"
                    })
                    .ToList()
                : new();
        }
        catch
        {
            Employees = new();
        }
    }

    private void RecalculateCounts()
    {
        _pendingCount = _allRequests.Count(r => r.StatusId == Status.Pending);
        _approvedCount = _allRequests.Count(r => r.StatusId == Status.Approved);
        _rejectedCount = _allRequests.Count(r => r.StatusId == Status.Rejected);
    }

    // ═══════════ EVENTS ═══════════

    private async Task FilterByStatus(Status? status)
    {
        _statusFilter = status;
        await LoadRequests();
    }

    private async Task ClearFilters()
    {
        _statusFilter = null;
        State.SelectedEmployeeId = null;
        _selectedEmployeeName = null;
        _selectedEmployeeNumber = null;
        await LoadRequests();
    }

    private async Task ClearEmployeeFilter()
    {
        State.SelectedEmployeeId = null;
        _selectedEmployeeName = null;
        _selectedEmployeeNumber = null;
        await LoadRequests();
    }

    private async Task OnEmployeeChanged(string? empId)
    {
        State.SelectedEmployeeId =
            !string.IsNullOrWhiteSpace(empId) && empId != "0"
                ? int.Parse(empId)
                : null;

        await LoadRequests();
    }

    private async Task OnEmployeeNameChanged(string? text)
    {
        _selectedEmployeeName = null;
        _selectedEmployeeNumber = null;

        if (!string.IsNullOrWhiteSpace(text))
        {
            var match = System.Text.RegularExpressions.Regex.Match(
                text, @"^(.*?)(?:\s*\((.*?)\))?$");

            if (match.Success)
            {
                _selectedEmployeeName = match.Groups[1].Value.Trim();
                _selectedEmployeeNumber = match.Groups[2].Value.Trim();
            }
        }

        await LoadRequests();
    }

    private async Task UpdateStatus(AttendanceRequestViewModel req, Status newStatus)
    {
        var action = newStatus == Status.Approved ? "approve" : "reject";

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"Are you sure you want to {action} this attendance request?");

        if (!confirmed) return;

        _isUpdating = true;
        StateHasChanged();

        try
        {
            var result = await AttendanceRequestService
                .UpdateRequestStatus(req.Id, newStatus);

            if (result?.IsSuccess == true)
            {
                NotificationService.Success($"Request {action}d successfully.");
                await LoadRequests();
            }
            else
            {
                NotificationService.Error(result?.Message ?? "Operation failed.");
            }
        }
        finally
        {
            _isUpdating = false;
        }
    }

    // ═══════════ HELPERS ═══════════

    private bool IsStatActive(Status? status) => _statusFilter == status;

    private string GetEmployeeValue()
        => State.SelectedEmployeeId?.ToString() ?? "0";

    private static string GetApproveClass(AttendanceRequestViewModel r)
        => r.StatusId == Status.Approved
            ? "btn btn-success shadow-sm"
            : "btn btn-outline-success";

    private static string GetRejectClass(AttendanceRequestViewModel r)
        => r.StatusId == Status.Rejected
            ? "btn btn-danger shadow-sm"
            : "btn btn-outline-danger";

    private static string TruncateName(string name, int maxLength)
        => name.Length <= maxLength ? name : $"{name[..maxLength]}…";

    // ═══════════ INNER TYPES ═══════════

    private record StatCardModel(
        Status? Status,
        string Icon,
        string BgClass,
        string TextClass,
        string ActiveClass,
        int Count,
        string Label);
}