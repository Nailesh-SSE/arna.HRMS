@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Components.lib.components.ui.Model
@using arna.HRMS.Models.ViewModels.Leave
@using arna.HRMS.Models.Enums
@using arna.HRMS.Services
@using arna.HRMS.Services.Common

@inject ILeaveService LeaveService
@inject NotificationService NotificationService

@if (ShowModal)
{
    <div class="modal fade show d-block leave-modal-backdrop" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

                <div class="modal-header bg-primary bg-gradient text-white px-4 py-3 border-0">
                    <h5 class="modal-title fw-semibold d-flex align-items-center gap-2 mb-0">
                        <i class="bi @(IsEditMode ? "bi-pencil-square" : "bi-bookmark-plus")"></i>
                        @(IsEditMode ? "Update Leave Type" : "Add Leave Type")
                    </h5>
                    <button type="button" class="btn-close btn-close-white"
                            @onclick="Close"></button>
                </div>

                <EditForm Model="leaveType" OnValidSubmit="OnSubmit">
                    <DataAnnotationsValidator />

                    <div class="modal-body px-4 pt-4 pb-3">

                        <div class="mb-3">
                            <AppSelect Label="Select Leave Type *"
                                       Options="leaveTypeOptions"
                                       Value="@GetLeaveNameValue()"
                                       ValueChanged="OnLeaveNameChanged"
                                       ValidationExpression="() => leaveType.LeaveNameId"
                                       Placeholder="Select leave type..." />
                        </div>

                        <div class="row g-3 align-items-end">
                            <div class="col-md-6">
                                <AppNumberInput Label="Max Days *"
                                                Value="@leaveType.MaxPerYear"
                                                ValueChanged="v => leaveType.MaxPerYear = v"
                                                ValidationExpression="() => leaveType.MaxPerYear" />
                            </div>
                            <div class="col-md-6 d-flex align-items-center pt-4">
                                <AppCheckBox Label="Paid Leave"
                                             Value="@leaveType.IsPaid"
                                             ValueChanged="v => leaveType.IsPaid = v" />
                            </div>
                        </div>

                        <div class="mt-3">
                            <AppTextArea Label="Description"
                                         Rows="3"
                                         Value="@leaveType.Description"
                                         ValueChanged="v => leaveType.Description = v"
                                         ValidationExpression="() => leaveType.Description"
                                         Placeholder="Brief description of this leave type..." />
                        </div>

                    </div>

                    <div class="modal-footer border-top bg-light px-4 py-3
                                    d-flex justify-content-end gap-2">
                        <button type="button"
                                class="btn btn-outline-secondary rounded-pill px-4"
                                @onclick="Close">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </button>
                        <button type="submit"
                                class="btn btn-primary rounded-pill px-4">
                            <i class="bi @(IsEditMode ? "bi-arrow-repeat" : "bi-check2-circle") me-1"></i>
                            @(IsEditMode ? "Update" : "Save")
                        </button>
                    </div>
                </EditForm>

            </div>
        </div>
    </div>
}

@code {

    [Parameter] public bool ShowModal { get; set; }
    [Parameter] public int? EditId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private LeaveTypeViewModel leaveType = new();
    private List<SelectOption> leaveTypeOptions = new();
    private bool isInitialized;

    private bool IsEditMode => EditId.HasValue;

    protected override async Task OnParametersSetAsync()
    {
        if (!ShowModal) { isInitialized = false; return; }
        if (isInitialized) return;
        isInitialized = true;

        LoadLeaveNameOptions();

        if (IsEditMode)
        {
            var result = await LeaveService.GetLeaveTypeByIdAsync(EditId!.Value);
            if (result?.IsSuccess == true && result.Data != null)
                leaveType = result.Data;
            else
            {
                await NotificationService.Error("Leave type not found");
                await Close();
            }
        }
        else
        {
            leaveType = new();
        }
    }

    private void LoadLeaveNameOptions()
    {
        leaveTypeOptions = Enum.GetValues<LeaveName>()
            .Select(e => new SelectOption
            {
                Value = ((int)e).ToString(),
                Text = FormatEnum(e.ToString())
            }).ToList();
    }

    private string GetLeaveNameValue()
    {
        var intVal = (int)leaveType.LeaveNameId;
        return intVal == 0 ? "" : intVal.ToString();
    }

    private void OnLeaveNameChanged(string? value)
    {
        leaveType.LeaveNameId = !string.IsNullOrEmpty(value) && int.TryParse(value, out int v)
            ? (LeaveName)v : default;
    }

    private async Task OnSubmit()
    {
        if(IsEditMode)
        {
            var result = await LeaveService.UpdateLeaveTypeAsync(EditId!.Value, leaveType);
            if (!result.IsSuccess)
            {
                await NotificationService.Error(result.Message ?? "");
                return;
            }
        }
        else
        {
            var result = await LeaveService.CreateLeaveTypeAsync(leaveType);
            if (!result.IsSuccess)
            {
                await NotificationService.Error(result.Message ?? "");
                return;
            }
        }

        await NotificationService.Success(IsEditMode ? "Leave type updated" : "Leave type created");
        await OnSaved.InvokeAsync();
    }

    private async Task Close()
    {
        isInitialized = false;
        leaveType = new();
        await OnClose.InvokeAsync();
    }

    private static string FormatEnum(string name) =>
        System.Text.RegularExpressions.Regex.Replace(name, "([a-z])([A-Z])", "$1 $2");
}