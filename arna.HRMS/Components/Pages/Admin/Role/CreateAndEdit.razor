@page "/role/create"
@page "/role/edit/{Id:int}"

@using arna.HRMS.ClientServices.Admin.Role
@using arna.HRMS.ClientServices.Common
@using arna.HRMS.Components.Loader
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Models.ViewModels

@inject IRoleService RoleService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<div class="container-fluid px-3 px-md-4 py-3 py-md-4">

    <!-- ═══════════ BACK + BREADCRUMB ═══════════ -->
    <div class="d-flex align-items-center gap-2 mb-3 mb-md-4 flex-wrap">
        <button class="btn btn-sm btn-outline-primary rounded-pill px-3 role-form-back-btn"
                @onclick="GoBack">
            <i class="bi bi-arrow-left me-1"></i>
            <span class="d-none d-sm-inline">Back</span>
        </button>
        <nav>
            <ol class="breadcrumb mb-0 small">
                <li class="breadcrumb-item">
                    <a href="/role" class="text-decoration-none text-primary">Roles</a>
                </li>
                <li class="breadcrumb-item active text-muted">
                    @(IsEditMode ? "Edit" : "Create")
                </li>
            </ol>
        </nav>
    </div>

    <!-- ═══════════ HEADER CARD ═══════════ -->
    <div class="card border-0 shadow-sm rounded-3 mb-3 mb-md-4 role-form-header">
        <div class="card-body py-3 px-3 px-md-4">
            <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2 gap-sm-3">

                <span class="role-form-header-icon rounded-2 p-2 d-inline-flex
                             align-items-center justify-content-center flex-shrink-0
                             @(IsEditMode ? "bg-warning bg-opacity-10 text-warning" : "bg-success bg-opacity-10 text-success")">
                    <i class="bi @(IsEditMode ? "bi-pencil-square" : "bi-shield-plus") fs-5"></i>
                </span>

                <div>
                    <h5 class="fw-bold mb-0 fs-6 fs-md-5">
                        @(IsEditMode ? "Edit Role" : "Add New Role")
                    </h5>
                    <p class="text-muted mb-0 small d-none d-sm-block">
                        @(IsEditMode
                                                ? $"Update details for {role.Name}"
                                                : "Fill in the details below to add a new role")
                    </p>
                </div>
            </div>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="card border-0 shadow-sm rounded-3">
            <div class="card-body text-center py-4 py-md-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2 mb-0 small">Loading role data…</p>
            </div>
        </div>
    }
    else
    {
        <EditForm Model="role" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <!-- ═══════════ ROLE DETAILS ═══════════ -->
            <div class="card border-0 shadow-sm rounded-3 mb-3 mb-md-4">
                <div class="card-header bg-white border-bottom py-2 py-md-3 px-3 px-md-4">
                    <div class="d-flex align-items-center gap-2">
                        <span class="role-form-section-icon bg-primary bg-opacity-10 text-primary
                                         rounded-2 d-inline-flex align-items-center justify-content-center">
                            <i class="bi bi-shield-fill"></i>
                        </span>
                        <div>
                            <h6 class="fw-semibold mb-0 small">Role Details</h6>
                            <small class="text-muted d-none d-md-block">
                                Basic role identification information
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body px-3 px-md-4 py-3">
                    <div class="row g-3">

                        <div class="col-12 col-md-6">
                            <AppInput Label="Name"
                                      Value="@role.Name"
                                      ValueChanged="v => role.Name = v"
                                      ValidationExpression="@(() => role.Name)" />
                        </div>

                        <div class="col-12 col-md-6">
                            <AppInput Label="Description"
                                      Value="@role.Description"
                                      ValueChanged="@(v => role.Description = v)"
                                      ValidationExpression="@(() => role.Description)" />
                        </div>

                    </div>
                </div>
            </div>

            <!-- ═══════════ STATUS (EDIT ONLY) ═══════════ -->
            @if (IsEditMode)
            {
                <div class="card border-0 shadow-sm rounded-3 mb-3 mb-md-4">
                    <div class="card-header bg-white border-bottom py-2 py-md-3 px-3 px-md-4">
                        <div class="d-flex align-items-center gap-2">
                            <span class="role-form-section-icon bg-warning bg-opacity-10 text-warning
                                                 rounded-2 d-inline-flex align-items-center justify-content-center">
                                <i class="bi bi-toggle-on"></i>
                            </span>
                            <div>
                                <h6 class="fw-semibold mb-0 small">Status</h6>
                                <small class="text-muted d-none d-md-block">
                                    Role activation status
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body px-3 px-md-4 py-3">
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <AppCheckBox Label="Active"
                                             Value="@role.IsActive"
                                             ValueChanged="@(v => role.IsActive = v)" />
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- ═══════════ ACTION BUTTONS ═══════════ -->
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-body px-3 px-md-4 py-3">
                    <div class="d-flex flex-column-reverse flex-sm-row
                                    justify-content-end gap-2 gap-sm-3">

                        <button type="button"
                                class="btn btn-outline-dark rounded-pill px-4 role-form-action-btn"
                                @onclick="GoBack">
                            <i class="bi bi-arrow-left me-1 d-none d-sm-inline"></i>
                            Back
                        </button>

                        <button type="submit"
                                class="btn btn-primary rounded-pill px-4 role-form-action-btn"
                                disabled="@_isSubmitting">
                            @if (_isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            }
                            else
                            {
                                <i class="bi @(IsEditMode ? "bi-check-lg" : "bi-plus-lg") me-1"></i>
                            }
                            @(IsEditMode ? "Update Role" : "Create Role")
                        </button>

                    </div>
                </div>
            </div>

        </EditForm>
    }
</div>

@code {

    // ═══════════ PARAMETERS ═══════════

    [Parameter] public int? Id { get; set; }

    // ═══════════ STATE ═══════════

    private RoleViewModel role = new();
    private bool _isLoading = true;
    private bool _isSubmitting;
    private bool IsEditMode => Id.HasValue;

    // ═══════════ LIFECYCLE ═══════════

    protected override async Task OnParametersSetAsync()
    {
        _isLoading = true;

        if (IsEditMode)
        {
            var result = await RoleService.GetRoleByIdAsync(Id!.Value);

            if (result.IsSuccess && result.Data != null)
            {
                role = result.Data;
            }
            else
            {
                NotificationService.Error($"{result.Message ?? "Role not found."}");
                NavigationManager.NavigateTo("/role");
            }
        }
        else
        {
            role = new RoleViewModel();
        }

        _isLoading = false;
    }

    // ═══════════ FORM SUBMIT ═══════════

    private async Task HandleValidSubmit()
    {
        _isSubmitting = true;
        StateHasChanged();

        try
        {
            bool isSuccess;
            string? errorMessage;

            if (IsEditMode)
            {
                var result = await RoleService.UpdateRoleAsync(Id!.Value, role);
                isSuccess = result.IsSuccess;
                errorMessage = result.Message;
            }
            else
            {
                var result = await RoleService.CreateRoleAsync(role);
                isSuccess = result.IsSuccess;
                errorMessage = result.Message;
            }

            if (!isSuccess)
            {
                NotificationService.Error(errorMessage ??
                    (IsEditMode ? "Unable to update role." : "Unable to create role."));
                return;
            }

            NotificationService.Success(
                IsEditMode ? "Role updated successfully." : "Role created successfully.");
            NavigationManager.NavigateTo("/role");
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    // ═══════════ NAVIGATION ═══════════

    private void GoBack() => NavigationManager.NavigateTo("/role");
}