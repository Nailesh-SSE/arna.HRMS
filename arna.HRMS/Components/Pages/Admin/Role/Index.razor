@page "/role"

@using arna.HRMS.Components.Loader
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Models.Common.Table
@using arna.HRMS.Models.ViewModels
@using arna.HRMS.Services
@using arna.HRMS.Services.Common

@inject NavigationManager NavigationManager
@inject IRoleService RoleService
@inject NotificationService NotificationService
@inject IJSRuntime JsRuntime

<Loader Visible="_isLoading" Message="@_loadingMessage" />

<div class="container-fluid px-3 px-md-4 py-3 py-md-4">

    <!-- ═══════════ HEADER ═══════════ -->
    <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center
                justify-content-between gap-3 gap-sm-4 mb-4 mb-md-5">
        <div class="d-flex align-items-start gap-3">
            <div class="role-header-icon bg-primary bg-opacity-10 text-primary rounded-2
                        d-inline-flex align-items-center justify-content-center flex-shrink-0">
                <i class="bi bi-shield-lock-fill"></i>
            </div>
            <div>
                <h4 class="fw-bold mb-2 fs-5 fs-md-4">Roles</h4>
                <p class="text-muted mb-0 small d-none d-sm-block">
                    Manage access roles and permissions
                </p>
            </div>
        </div>

        <button class="btn btn-primary btn-sm rounded-pill px-4 role-add-btn w-100 w-sm-auto"
                @onclick="@(() => NavigateTo("/role/create"))">
            <i class="bi bi-plus-lg me-1"></i>
            <span class="d-none d-sm-inline">Add Role</span>
            <span class="d-sm-none">Add</span>
        </button>
    </div>

    <!-- ═══════════ STAT CARDS ═══════════ -->
    <div class="row g-2 g-sm-3 mb-4 mb-md-5">
        @foreach (var stat in StatCards)
        {
            <div class="col-6 col-md-3">
                <div class="card border-0 shadow-sm rounded-3 role-stat-card h-100">
                    <div class="card-body text-center py-3 py-md-4 px-3">
                        <div class="role-stat-icon @stat.BgClass mx-auto mb-2">
                            <i class="bi @stat.Icon @stat.TextClass"></i>
                        </div>
                        <div class="fs-4 fw-bold @stat.TextClass mb-2">@stat.Count</div>
                        <small class="text-muted fw-semibold text-uppercase role-stat-label">
                            @stat.Label
                        </small>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- ═══════════ SEARCH BAR ═══════════ -->
    <div class="card border-0 shadow-sm rounded-3 mb-4">
        <div class="card-body py-3 px-3 px-md-4">
            <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-search text-primary"></i>
                    <span class="fw-medium text-muted small">Filter</span>
                </div>

                <div class="flex-grow-1" style="min-width: 250px;">
                    <input type="text"
                           class="form-control form-control-sm border-0 bg-light rounded-pill"
                           placeholder="Search by name or description..."
                           @bind="_searchTerm"
                           @bind:event="oninput" />
                </div>

                @if (!string.IsNullOrWhiteSpace(_searchTerm))
                {
                    <button class="btn btn-sm btn-outline-secondary rounded-pill px-3"
                            @onclick="ClearSearch">
                        <i class="bi bi-x-lg me-1"></i>
                        <span class="d-none d-sm-inline">Clear</span>
                    </button>
                }
            </div>
        </div>
    </div>

    <!-- ═══════════ TABLE ═══════════ -->
    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-header bg-white border-bottom py-3 px-3 px-md-4">
            <div class="d-flex align-items-center justify-content-between">
                <h6 class="fw-semibold mb-0 small">
                    <i class="bi bi-table text-primary me-2"></i>
                    <span class="d-none d-sm-inline">Role Directory</span>
                    <span class="d-sm-none">Directory</span>
                </h6>
                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3 py-2">
                    @FilteredRoles.Count
                    <span class="d-none d-sm-inline ms-1">roles</span>
                </span>
            </div>
        </div>

        <div class="card-body p-0">
            @if (_isLoading)
            {
                <div class="text-center py-5 py-md-6">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p class="text-muted mb-0 small">Loading roles…</p>
                </div>
            }
            else if (!FilteredRoles.Any())
            {
                <div class="text-center py-5 py-md-6 px-3">
                    <div class="role-empty-icon bg-light rounded-3 d-inline-flex
                                    align-items-center justify-content-center mx-auto mb-3">
                        <i class="bi bi-inbox fs-1 text-muted opacity-50"></i>
                    </div>
                    <h6 class="fw-semibold text-muted mb-2">No Roles Found</h6>
                    <p class="text-muted small mb-4 role-empty-text mx-auto">
                        @if (!string.IsNullOrWhiteSpace(_searchTerm))
                        {
                            <span>No roles match "<strong>@_searchTerm</strong>"</span>
                        }
                        else
                        {
                            <span>No roles have been added yet.</span>
                        }
                    </p>
                    @if (!string.IsNullOrWhiteSpace(_searchTerm))
                    {
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-4"
                                @onclick="ClearSearch">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Clear Search
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-primary rounded-pill px-4"
                                @onclick="@(() => NavigateTo("/role/create"))">
                            <i class="bi bi-plus-lg me-1"></i>Add First Role
                        </button>
                    }
                </div>
            }
            else
            {
                <div class="role-table-scroll">
                    <AppTable TItem="RoleViewModel"
                              Items="FilteredRoles"
                              Columns="TableSchemas.Roles"
                              OnEdit="EditRole"
                              OnDelete="DeleteRole" />
                </div>
            }
        </div>
    </div>
</div>

@code {

    // ═══════════ STATE ═══════════

    private List<RoleViewModel> _roles = new();
    private bool _isLoading = true;
    private string _loadingMessage = "Loading roles...";
    private string? _searchTerm;

    // ═══════════ COMPUTED ═══════════

    private List<RoleViewModel> FilteredRoles
        => string.IsNullOrWhiteSpace(_searchTerm)
            ? _roles
            : _roles
                .Where(r =>
                    MatchesSearch(r.Name) ||
                    MatchesSearch(r.Description))
                .ToList();

    private IEnumerable<StatCardModel> StatCards => new[]
    {
        new StatCardModel("bi-shield-fill",        "bg-primary bg-opacity-10", "text-primary", _roles.Count,                   "Total"),
        new StatCardModel("bi-check-circle-fill",  "bg-success bg-opacity-10", "text-success", _roles.Count(r => r.IsActive),  "Active"),
        new StatCardModel("bi-x-circle-fill",      "bg-danger bg-opacity-10",  "text-danger",  _roles.Count(r => !r.IsActive), "Inactive"),
    };

    // ═══════════ LIFECYCLE ═══════════

    protected override async Task OnInitializedAsync()
    {
        await LoadRolesAsync();
    }

    // ═══════════ DATA ═══════════

    private async Task LoadRolesAsync()
    {
        _isLoading = true;

        var result = await RoleService.GetRolesAsync();

        if (result.IsSuccess && result.Data != null)
        {
            _roles = result.Data;
        }
        else if (!result.IsSuccess)
        {
            await NotificationService.Error(result.Message ?? "Failed to load roles");
            _roles = new List<RoleViewModel>();
        }
        else
        {
            _roles = new List<RoleViewModel>();
        }

        _isLoading = false;
    }

    // ═══════════ EVENTS ═══════════

    private void NavigateTo(string route)
        => NavigationManager.NavigateTo(route);

    private void EditRole(RoleViewModel model)
        => NavigationManager.NavigateTo($"/role/edit/{model.Id}");

    private async Task DeleteRole(RoleViewModel model)
    {
        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm", "Are you sure you want to delete this role?");

        if (!confirmed) return;

        var result = await RoleService.DeleteRoleAsync(model.Id);

        if (!result.IsSuccess)
        {
            await NotificationService.Error(result.Message ?? "Unable to delete role.");
            return;
        }

        await NotificationService.Success("Role deleted successfully.");
        await LoadRolesAsync();
    }

    private void ClearSearch() => _searchTerm = null;

    // ═══════════ HELPERS ═══════════

    private bool MatchesSearch(string? value)
        => !string.IsNullOrWhiteSpace(value) &&
           value.Contains(_searchTerm!, StringComparison.OrdinalIgnoreCase);

    // ═══════════ INNER TYPES ═══════════

    private record StatCardModel(
        string Icon, string BgClass, string TextClass, int Count, string Label);
}