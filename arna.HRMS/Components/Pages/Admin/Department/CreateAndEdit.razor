@page "/department/create"
@page "/department/edit/{Id:int?}"

@using arna.HRMS.Components.Loader
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Components.lib.components.ui.Model
@using arna.HRMS.Models.ViewModels
@using arna.HRMS.Services
@using arna.HRMS.Services.Common

@inject IDepartmentService DepartmentService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<div class="container-fluid px-3 px-md-4 py-3 py-md-4">

    <!-- ═══════════ BACK + BREADCRUMB ═══════════ -->
    <div class="d-flex align-items-center gap-2 mb-3 mb-md-4 flex-wrap">
        <button class="btn btn-sm btn-outline-primary rounded-pill px-3 dept-form-back-btn"
                @onclick="GoBack">
            <i class="bi bi-arrow-left me-1"></i>
            <span class="d-none d-sm-inline">Back</span>
        </button>
        <nav>
            <ol class="breadcrumb mb-0 small">
                <li class="breadcrumb-item">
                    <a href="/department" class="text-decoration-none text-primary">Departments</a>
                </li>
                <li class="breadcrumb-item active text-muted">
                    @(IsEditMode ? "Edit" : "Create")
                </li>
            </ol>
        </nav>
    </div>

    <!-- ═══════════ HEADER CARD ═══════════ -->
    <div class="card border-0 shadow-sm rounded-3 mb-3 mb-md-4 dept-form-header">
        <div class="card-body py-3 px-3 px-md-4">
            <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2 gap-sm-3">

                <span class="dept-form-header-icon rounded-2 p-2 d-inline-flex
                             align-items-center justify-content-center flex-shrink-0
                             @(IsEditMode ? "bg-warning bg-opacity-10 text-warning" : "bg-success bg-opacity-10 text-success")">
                    <i class="bi @(IsEditMode ? "bi-pencil-square" : "bi-diagram-3-fill") fs-5"></i>
                </span>

                <div>
                    <h5 class="fw-bold mb-0 fs-6 fs-md-5">
                        @(IsEditMode ? "Edit Department" : "Add New Department")
                    </h5>
                    <p class="text-muted mb-0 small d-none d-sm-block">
                        @(IsEditMode
                                                ? $"Update details for {department.Name}"
                                                : "Fill in the details below to add a new department")
                    </p>
                </div>
            </div>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="card border-0 shadow-sm rounded-3">
            <div class="card-body text-center py-4 py-md-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2 mb-0 small">Loading department data…</p>
            </div>
        </div>
    }
    else
    {
        <EditForm Model="department" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <!-- ═══════════ DEPARTMENT INFORMATION ═══════════ -->
            <div class="card border-0 shadow-sm rounded-3 mb-3 mb-md-4">
                <div class="card-header bg-white border-bottom py-2 py-md-3 px-3 px-md-4">
                    <div class="d-flex align-items-center gap-2">
                        <span class="dept-form-section-icon bg-primary bg-opacity-10 text-primary
                                         rounded-2 d-inline-flex align-items-center justify-content-center">
                            <i class="bi bi-building-fill"></i>
                        </span>
                        <div>
                            <h6 class="fw-semibold mb-0 small">Department Information</h6>
                            <small class="text-muted d-none d-md-block">
                                Basic department identification details
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body px-3 px-md-4 py-3">
                    <div class="row g-3">

                        <div class="col-12 col-md-6">
                            <AppInput Label="Department Name"
                                      Value="@department.Name"
                                      ValueChanged="v => department.Name = v"
                                      ValidationExpression="() => department.Name" />
                        </div>

                        <div class="col-12 col-md-6">
                            <AppInput Label="Code"
                                      Value="@department.Code"
                                      ValueChanged="v => department.Code = v"
                                      ValidationExpression="() => department.Code" />
                        </div>

                        <div class="col-12 col-md-6">
                            <AppInput Label="Description"
                                      Value="@department.Description"
                                      ValueChanged="v => department.Description = v"
                                      ValidationExpression="() => department.Description" />
                        </div>

                        <div class="col-12 col-md-6">
                            <AppSelect Label="Parent Department"
                                       Options="@_departmentOptions"
                                       Value="@department.ParentDepartmentId?.ToString()"
                                       ValueChanged="v =>
                                                                              {
                                                                                  department.ParentDepartmentId =
                                                                                      int.TryParse(v, out var d) ? d : null;
                                                                              }"
                                   ValidationExpression="() => department.ParentDepartmentId" />
                    </div>

                                                           </div>
                                                       </div>
                                                   </div>

                                                   <!-- ═══════════ STATUS (EDIT ONLY) ═══════════ -->
        @if (IsEditMode)
            {
                <div class="card border-0 shadow-sm rounded-3 mb-3 mb-md-4">
                    <div class="card-header bg-white border-bottom py-2 py-md-3 px-3 px-md-4">
                        <div class="d-flex align-items-center gap-2">
                            <span class="dept-form-section-icon bg-warning bg-opacity-10 text-warning
                                                 rounded-2 d-inline-flex align-items-center justify-content-center">
                                <i class="bi bi-toggle-on"></i>
                            </span>
                            <div>
                                <h6 class="fw-semibold mb-0 small">Status</h6>
                                <small class="text-muted d-none d-md-block">
                                    Department activation status
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body px-3 px-md-4 py-3">
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <AppCheckBox Label="Active"
                                             Value="@department.IsActive"
                                             ValueChanged="@(v => department.IsActive = v)" />
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- ═══════════ ACTION BUTTONS ═══════════ -->
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-body px-3 px-md-4 py-3">
                    <div class="d-flex flex-column-reverse flex-sm-row
                                    justify-content-end gap-2 gap-sm-3">

                        <button type="button"
                                class="btn btn-outline-dark rounded-pill px-4 dept-form-action-btn"
                                @onclick="GoBack">
                            <i class="bi bi-arrow-left me-1 d-none d-sm-inline"></i>
                            Back
                        </button>

                        <button type="submit"
                                class="btn btn-primary rounded-pill px-4 dept-form-action-btn"
                                disabled="@_isSubmitting">
                            @if (_isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            }
                            else
                            {
                                <i class="bi @(IsEditMode ? "bi-check-lg" : "bi-plus-lg") me-1"></i>
                            }
                            @(IsEditMode ? "Update Department" : "Create Department")
                        </button>

                    </div>
                </div>
            </div>

        </EditForm>
    }
</div>

@code {

    // ═══════════ PARAMETERS ═══════════

    [Parameter] public int? Id { get; set; }

    // ═══════════ STATE ═══════════

    private DepartmentViewModel department = new();
    private bool _isLoading = true;
    private bool _isSubmitting;
    private bool IsEditMode => Id.HasValue;
    private List<SelectOption> _departmentOptions = new();

    // ═══════════ LIFECYCLE ═══════════

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;

        await LoadDepartmentOptions();
        await LoadDepartmentIfEditing();

        _isLoading = false;
    }

    // ═══════════ DATA LOADING ═══════════

    private async Task LoadDepartmentOptions()
    {
        var result = await DepartmentService.GetDepartmentsAsync();

        _departmentOptions = result is { IsSuccess: true, Data: not null }
            ? result.Data
                .Select(d => new SelectOption { Value = d.Id.ToString(), Text = d.Name })
                .ToList()
            : new();
    }

    private async Task LoadDepartmentIfEditing()
    {
        if (!IsEditMode)
        {
            department = new DepartmentViewModel { IsActive = true };
            return;
        }

        var result = await DepartmentService.GetDepartmentByIdAsync(Id!.Value);

        if (result is not { IsSuccess: true, Data: not null })
        {
            await NotificationService.Error(result?.Message ?? "Department not found.");
            NavigationManager.NavigateTo("/department");
            return;
        }

        department = result.Data;
    }

    // ═══════════ FORM SUBMIT ═══════════

    private async Task HandleValidSubmit()
    {
        _isSubmitting = true;
        StateHasChanged();

        try
        {
            bool isSuccess;
            string? errorMessage;

            if (IsEditMode)
            {
                var result = await DepartmentService.UpdateDepartmentAsync(Id!.Value, department);
                isSuccess = result.IsSuccess;
                errorMessage = result.Message;
            }
            else
            {
                var result = await DepartmentService.CreateDepartmentAsync(department);
                isSuccess = result.IsSuccess;
                errorMessage = result.Message;
            }

            if (!isSuccess)
            {
                await NotificationService.Error(errorMessage ?? (IsEditMode ? "Unable to update department." : "Unable to create department."));
                return;
            }

            await NotificationService.Success(IsEditMode ? "Department updated successfully." : "Department created successfully.");
            NavigationManager.NavigateTo("/department");
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    // ═══════════ NAVIGATION ═══════════

    private void GoBack() => NavigationManager.NavigateTo("/department");
}