@using arna.HRMS.ClientServices.Common
@using arna.HRMS.ClientServices.Leave
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Components.lib.components.ui.Model
@using arna.HRMS.Models.ViewModels.Leave
@using arna.HRMS.Models.Enums

@inject ILeaveService LeaveService
@inject NotificationService NotificationService

@if (ShowModal)
{
    <div class="modal fade show d-block leave-modal-backdrop" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content leave-modal">

                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-semibold">
                        @(IsEditMode ? "Update Leave Type" : "Add Leave Type")
                    </h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>

                <EditForm Model="leaveType" OnValidSubmit="OnSubmit">
                    <DataAnnotationsValidator />

                    <div class="modal-body pt-3">

                        <div class="mb-3">
                            @* ──── FIXED: Bind enum value as int string ──── *@
                            <AppSelect Label="Select Leave Type *"
                                       Options="leaveTypeOptions"
                                       Value="@(((int)leaveType.LeaveNameId).ToString())"
                                       ValueChanged="OnLeaveNameChanged"
                                       ValidationExpression="() => leaveType.LeaveNameId"
                                       Placeholder="Select....." />
                        </div>

                        <div class="row g-3 align-items-end">
                            <div class="col-md-6">
                                <AppNumberInput Label="Max Days *"
                                                Value="@leaveType.MaxPerYear"
                                                ValueChanged="v => leaveType.MaxPerYear = v"
                                                ValidationExpression="() => leaveType.MaxPerYear" />
                            </div>
                            <div class="col-md-6 d-flex align-items-center pt-4">
                                <div class="form-check leave-checkbox">
                                    <AppCheckBox Label="Paid Leave"
                                                 Value="@leaveType.IsPaid"
                                                 ValueChanged="v => leaveType.IsPaid = v" />
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <AppTextArea Label="Description *"
                                         Rows="3"
                                         Value="@leaveType.Description"
                                         ValidationExpression="() => leaveType.Description"
                                         Placeholder="Please provide description for leave..." />
                        </div>

                    </div>

                    <div class="modal-footer border-0 pt-0">
                        <AppButton ButtonClass="btn btn-light px-4"
                                   OnClick="Close">
                            Cancel
                        </AppButton>
                        <AppButton ButtonClass="btn btn-primary px-4" type="submit">
                            @(IsEditMode ? "Update" : "Save")
                        </AppButton>
                    </div>
                </EditForm>

            </div>
        </div>
    </div>
}

@code {

    [Parameter] public bool ShowModal { get; set; }
    [Parameter] public int? EditId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private LeaveTypeViewModel leaveType = new();
    private List<SelectOption> leaveTypeOptions = new();
    private bool isInitialized = false;

    private bool IsEditMode => EditId.HasValue;

    protected override async Task OnParametersSetAsync()
    {
        if (!ShowModal)
        {
            isInitialized = false;
            return;
        }

        if (isInitialized) return;
        isInitialized = true;

        LoadLeaveNameOptions();

        if (IsEditMode)
        {
            var result = await LeaveService.GetLeaveTypeByIdAsync(EditId!.Value);

            if (result.IsSuccess && result.Data != null)
            {
                leaveType = result.Data;
            }
            else
            {
                NotificationService.Error("Leave type not found");
                await Close();
            }
        }
        else
        {
            leaveType = new LeaveTypeViewModel();
        }
    }

    private void LoadLeaveNameOptions()
    {
        leaveTypeOptions = Enum.GetValues<LeaveName>()
            .Select(e => new SelectOption
            {
                Value = ((int)e).ToString(),       
                Text = FormatEnumName(e.ToString()) 
            })
            .ToList();
    }

    private string FormatEnumName(string name)
    {
        return System.Text.RegularExpressions.Regex
            .Replace(name, "([a-z])([A-Z])", "$1 $2");
    }

    private void OnLeaveNameChanged(string value)
    {
        if (int.TryParse(value, out int intValue))
        {
            leaveType.LeaveNameId = (LeaveName)intValue;
        }
    }

    private async Task OnSubmit()
    {
        bool success;
        string message;

        if (IsEditMode)
        {
            var result = await LeaveService.UpdateLeaveTypeAsync(EditId!.Value, leaveType);
            success = result.IsSuccess;
            message = result.Message;
        }
        else
        {
            var result = await LeaveService.CreateLeaveTypeAsync(leaveType);
            success = result.IsSuccess;
            message = result.Message;
        }

        if (!success)
        {
            NotificationService.Error(message);
            return;
        }

        NotificationService.Success(
            IsEditMode ? "Leave Type updated" : "Leave Type created"
        );

        await OnSaved.InvokeAsync();
    }

    private async Task Close()
    {
        isInitialized = false;
        leaveType = new LeaveTypeViewModel();
        await OnClose.InvokeAsync();
    }
}