@page "/leaveTypes"

@using arna.HRMS.ClientServices.Common
@using arna.HRMS.ClientServices.Leave
@using arna.HRMS.Components.Loader
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Models.Common.Table
@using arna.HRMS.Models.Enums
@using arna.HRMS.Models.ViewModels.Leave

@inject NavigationManager NavigationManager
@inject ILeaveService LeaveService
@inject IJSRuntime JsRuntime
@inject NotificationService NotificationService

<FullPageLoader Visible="isLoading" />

<div class="container mt-4">

    <!-- HEADER -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">

            <div>
                <h4 class="fw-bold text-primary mb-0">
                    <i class="bi bi-briefcase-fill me-2"></i>
                    LeaveTypes
                </h4>

                <small class="text-muted">
                    @(showLeaveRequests
                                        ? "View employee leave requests"
                                        : "Manage leave types and policies")
                </small>
            </div>

            <div class="d-flex gap-2">

                @if (!showLeaveRequests)
                {
                    <AppButton ButtonClass="btn btn-primary px-3"
                               Text="Add Leave"
                               OnClick="@(() => NavigationManager.NavigateTo("/leaveMaster/create"))">
                        <i class="bi bi-plus-circle me-1"></i>
                    </AppButton>

                    <AppButton ButtonClass="btn btn-outline-dark px-3"
                               Text="View Requests"
                               OnClick="ShowLeaveRequests">
                        <i class="bi bi-eye me-1"></i>
                    </AppButton>
                }
                else
                {
                    <AppButton ButtonClass="btn btn-outline-secondary px-3"
                               Text="Back"
                               OnClick="ShowLeaveMasters">
                        <i class="bi bi-arrow-left me-1"></i>
                    </AppButton>
                }

            </div>
        </div>
    </div>

    <!-- TABLE SWITCH -->
    <div class="card shadow-sm border-0">
        <div class="card-body">

            @if (!showLeaveRequests)
            {
                <!-- LEAVE MASTER TABLE -->
                <AppTable TItem="LeaveMasterViewModel"
                          Items="leaveMasters"
                          Columns="TableSchemas.LeaveMasters"
                          OnEdit="EditLeaveMaster"
                          OnDelete="DeleteLeaveMaster" />
            }
            else
            {
                <!-- LEAVE REQUEST TABLE -->
                <AppTable TItem="LeaveRequestViewModel"
                          Items="leaveRequests"
                          Columns="TableSchemas.LeaveRequest">

                    <ActionTemplate Context="req">
                        @if (req.StatusId != Status.Cancelled)
                        {
                            <AppButton ButtonClass="@GetApproveButtonClass(req)"
                                       OnClick="() => UpdateLeaveStatus(req, Status.Approved)">
                                <i class="bi bi-check-circle"></i>
                            </AppButton>

                            <AppButton ButtonClass="@GetRejectButtonClass(req)"
                                       OnClick="() => UpdateLeaveStatus(req, Status.Rejected)">
                                <i class="bi bi-x-circle"></i>
                            </AppButton>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Cancelled</span>
                        }
                    </ActionTemplate>

                </AppTable>

            }

        </div>
    </div>

</div>

@code {

    private bool showLeaveRequests = false;
    private bool isLoading = true;

    private List<LeaveMasterViewModel> leaveMasters = new();
    private List<LeaveRequestViewModel> leaveRequests = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLeaveMasters();
    }

    private async Task LoadLeaveMasters()
    {
        isLoading = true;

        var result = await LeaveService.GetLeaveMasterAsync();

        if (result.IsSuccess && result.Data != null)
        {
            leaveMasters = result.Data;
        }
        else
        {
            leaveMasters.Clear();
            NotificationService.Error(result.Message ?? "Failed to load Leave Masters");
        }

        isLoading = false;
    }

    private async Task UpdateLeaveStatus(LeaveRequestViewModel req, Status newStatus)
    {
        // Don't allow status change for cancelled requests
        if (req.StatusId == Status.Cancelled)
        {
            NotificationService.Warning("Cannot modify a cancelled leave request.");
            return;
        }

        string action = newStatus == Status.Approved ? "approve" : "reject";
        string currentStatusText = req.StatusId == Status.Pending ? "pending" :
                                   req.StatusId == Status.Approved ? "approved" : "rejected";

        bool isConfirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"Are you sure you want to {action} this {currentStatusText} leave request?"
        );

        if (!isConfirmed)
            return;

        isLoading = true;

        var result = await LeaveService.UpdateStatusLeaveAsync(
            req.Id,
            newStatus
        );

        if (!result.IsSuccess)
        {
            NotificationService.Error(
                result.Message ?? "Failed to update leave status"
            );
            isLoading = false;
            return;
        }

        // Update UI immediately
        req.StatusId = newStatus;
        req.ApprovedDate = DateTime.Now;

        NotificationService.Success(
            newStatus == Status.Approved
                ? "Leave approved successfully"
                : "Leave rejected successfully"
        );

        isLoading = false;
    }

    private string GetApproveButtonClass(LeaveRequestViewModel req)
    {
        return req.StatusId == Status.Approved
            ? "btn btn-sm btn-success"
            : "btn btn-sm btn-outline-success";
    }

    private string GetRejectButtonClass(LeaveRequestViewModel req)
    {
        return req.StatusId == Status.Rejected
            ? "btn btn-sm btn-danger"
            : "btn btn-sm btn-outline-danger";
    }

    private async Task LoadLeaveRequests()
    {
        isLoading = true;

        var result = await LeaveService.GetLeaveRequestAsync();

        if (result.IsSuccess && result.Data != null)
        {
            leaveRequests = result.Data;
        }
        else
        {
            leaveRequests.Clear();
            NotificationService.Error(result.Message ?? "Unable to load leave requests");
        }

        isLoading = false;
    }

    private async Task ShowLeaveRequests()
    {
        showLeaveRequests = true;

        if (leaveRequests.Count == 0)
        {
            await LoadLeaveRequests();
        }
    }

    private void ShowLeaveMasters()
    {
        showLeaveRequests = false;
    }

    private void EditLeaveMaster(LeaveMasterViewModel model)
    {
        NavigationManager.NavigateTo($"/leaveMaster/edit/{model.Id}");
    }

    private async Task DeleteLeaveMaster(LeaveMasterViewModel model)
    {
        bool isConfirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            "Are you sure you want to delete this leave Master?"
        );

        if (!isConfirmed)
            return;

        var result = await LeaveService.DeleteLeaveMasterAsync(model.Id);

        if (!result.IsSuccess)
        {
            NotificationService.Error(result.Message ?? "Unable to delete leave Master.");
            return;
        }

        NotificationService.Success("Leave Master deleted successfully.");
        await LoadLeaveMasters();
    }
}