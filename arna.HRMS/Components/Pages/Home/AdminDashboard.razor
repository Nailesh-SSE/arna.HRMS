@using arna.HRMS.ClientServices.Admin.Employee
@using arna.HRMS.ClientServices.Leave
@using arna.HRMS.ClientServices.Common
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Models.Common.Table
@using arna.HRMS.Models.ViewModels.Leave
@using arna.HRMS.Models.Enums

@inject NavigationManager Nav
@inject IEmployeeService EmployeeService
@inject ILeaveService LeaveService
@inject NotificationService NotificationService
@inject IJSRuntime JsRuntime

<div class="container-fluid px-3 px-md-4 py-3 dash-fade-in">

    <!-- ══════════ HEADER ══════════ -->
    <div class="row align-items-center mb-4">
        <div class="col">
            <h3 class="fw-bold mb-1">@greeting, @UserFullName</h3>
            <p class="text-muted mb-0">
                <i class="bi bi-calendar3 me-1"></i>
                @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
                <span class="mx-1">•</span>
                <i class="bi bi-clock me-1"></i>
                @DateTime.Now.ToString("hh:mm tt")
                <span class="badge bg-primary bg-opacity-10 text-primary ms-2 fw-medium">
                    <i class="bi bi-shield-check me-1"></i>Admin Panel
                </span>
            </p>
        </div>
    </div>

    <!-- ══════════ STAT CARDS ══════════ -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-3 h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-people-fill fs-4"></i>
                    </div>
                    <div>
                        <small class="text-muted d-block">Total Employees</small>
                        <span class="fs-3 fw-bold lh-1">@totalEmployees</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-3 h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="stat-icon bg-success bg-opacity-10 text-success">
                        <i class="bi bi-calendar-check-fill fs-4"></i>
                    </div>
                    <div>
                        <small class="text-muted d-block">On Leave Today</small>
                        <span class="fs-3 fw-bold lh-1">@onLeaveToday</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-3 h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="stat-icon bg-warning bg-opacity-25 text-warning">
                        <i class="bi bi-hourglass-split fs-4"></i>
                    </div>
                    <div>
                        <small class="text-muted d-block">Pending Requests</small>
                        <span class="fs-3 fw-bold lh-1">@pendingCount</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-3 h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="stat-icon bg-info bg-opacity-10 text-info">
                        <i class="bi bi-check2-all fs-4"></i>
                    </div>
                    <div>
                        <small class="text-muted d-block">Approved (Month)</small>
                        <span class="fs-3 fw-bold lh-1">@approvedThisMonth</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ══════════ PENDING + OVERVIEW ══════════ -->
    <div class="row g-4 mb-4">

        <!-- Pending Leave Requests (AppTable) -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-3 h-100">
                <div class="card-header bg-transparent border-bottom
                            d-flex align-items-center justify-content-between py-3">
                    <h6 class="fw-semibold mb-0">
                        <i class="bi bi-inbox-fill text-warning me-2"></i>
                        Pending Leave Requests
                        @if (pendingCount > 0)
                        {
                            <span class="badge bg-warning text-dark rounded-pill ms-1">
                                @pendingCount
                            </span>
                        }
                    </h6>
                    <a href="/admin-leave-management"
                       class="btn btn-sm btn-outline-primary rounded-pill">
                        View All <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>

                <div class="card-body p-0">
                    <div class="dash-scroll-area">
                        <AppTable TItem="LeaveRequestViewModel"
                                  Items="pendingLeaveRequests"
                                  Columns="TableSchemas.DashboardPendingLeaves">

                            <ActionTemplate Context="req">
                                <button class="btn btn-sm btn-outline-success me-1"
                                        title="Approve"
                                        @onclick="() => ApproveLeave(req)">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger"
                                        title="Reject"
                                        @onclick="() => RejectLeave(req)">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </ActionTemplate>

                        </AppTable>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leave Overview -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-3 h-100">
                <div class="card-header bg-transparent border-bottom py-3">
                    <h6 class="fw-semibold mb-0">
                        <i class="bi bi-pie-chart-fill text-primary me-2"></i>
                        Leave Overview
                    </h6>
                </div>
                <div class="card-body">
                    @{
                        var totalReqs = allLeaveRequests.Count;
                    }

                    @foreach (var item in overviewItems)
                    {
                        <div class="d-flex align-items-center mb-3">
                            <span class="status-dot @item.DotClass me-2"></span>
                            <span class="small flex-grow-1">@item.Label</span>
                            <span class="fw-bold small">@item.Count</span>
                        </div>
                        <div class="progress mb-3" style="height:6px;">
                            <div class="progress-bar @item.BarClass"
                                 style="width:@Pct(item.Count, totalReqs)%"></div>
                        </div>
                    }

                    <hr />
                    <div class="text-center">
                        <div class="text-muted small mb-1">Total Requests</div>
                        <div class="fs-2 fw-bold text-primary">@totalReqs</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ══════════ RECENT APPROVED / REJECTED ══════════ -->
    <div class="row g-4 mb-4">

        <!-- Recently Approved -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-transparent border-bottom py-3">
                    <h6 class="fw-semibold mb-0">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        Recently Approved
                    </h6>
                </div>
                <div class="card-body p-0">
                    @if (recentApproved.Any())
                    {
                        <div class="dash-scroll-area-sm">
                            <ul class="list-group list-group-flush">
                                @foreach (var r in recentApproved)
                                {
                                    <li class="list-group-item d-flex
                                                       align-items-center gap-3 px-3">
                                        <div class="avatar-sm avatar-green">
                                            @GetInitials(r.EmployeeName)
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-medium small">@r.EmployeeName</div>
                                            <small class="text-muted">
                                                @GetLeaveTypeName(r.LeaveTypeId) •
                                                @r.LeaveDays day(s)
                                            </small>
                                        </div>
                                        <small class="text-muted">
                                            @r.StartDate.ToString("MMM dd")
                                        </small>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-4 mb-0">No recent approvals</p>
                    }
                </div>
            </div>
        </div>

        <!-- Recently Rejected -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-transparent border-bottom py-3">
                    <h6 class="fw-semibold mb-0">
                        <i class="bi bi-x-circle text-danger me-2"></i>
                        Recently Rejected
                    </h6>
                </div>
                <div class="card-body p-0">
                    @if (recentRejected.Any())
                    {
                        <div class="dash-scroll-area-sm">
                            <ul class="list-group list-group-flush">
                                @foreach (var r in recentRejected)
                                {
                                    <li class="list-group-item d-flex
                                                       align-items-center gap-3 px-3">
                                        <div class="avatar-sm avatar-red">
                                            @GetInitials(r.EmployeeName)
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-medium small">@r.EmployeeName</div>
                                            <small class="text-muted">
                                                @GetLeaveTypeName(r.LeaveTypeId) •
                                                @r.LeaveDays day(s)
                                            </small>
                                        </div>
                                        <small class="text-muted">
                                            @r.StartDate.ToString("MMM dd")
                                        </small>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-4 mb-0">No recent rejections</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- ══════════ QUICK ACTIONS ══════════ -->
    <div class="mb-2">
        <h6 class="fw-semibold mb-3">
            <i class="bi bi-grid me-2"></i>Quick Access
        </h6>
        <div class="row g-3">
            @foreach (var a in quickActions)
            {
                <div class="col-6 col-sm-4 col-md-3 col-xl-2">
                    <div class="card border-0 shadow-sm rounded-3
                                    text-center action-tile h-100"
                         role="button"
                         @onclick="() => Nav.NavigateTo(a.Route)">
                        <div class="card-body py-4">
                            <div class="action-icon-circle @a.Bg mb-2 mx-auto">
                                <i class="@a.Icon @a.TextColor fs-5"></i>
                            </div>
                            <div class="fw-semibold small">@a.Label</div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

</div>

@code {

    [Parameter] public string UserFullName { get; set; } = "";

    private string greeting = "";

    // ── Data ──
    private List<LeaveTypeViewModel> leaveTypes = new();
    private Dictionary<int, string> leaveTypeNames = new();
    private List<LeaveRequestViewModel> allLeaveRequests = new();
    private List<LeaveRequestViewModel> pendingLeaveRequests = new();
    private List<LeaveRequestViewModel> recentApproved = new();
    private List<LeaveRequestViewModel> recentRejected = new();

    // ── Stats ──
    private int totalEmployees;
    private int onLeaveToday;
    private int pendingCount;
    private int approvedThisMonth;
    private int approvedTotal;
    private int rejectedTotal;
    private int cancelledTotal;

    // ── Overview items ──
    private record OverviewItem(string Label, int Count, string DotClass, string BarClass);
    private List<OverviewItem> overviewItems = new();

    // ── Quick Actions ──
    private record QuickAction(string Label, string Icon, string Route,
                               string Bg, string TextColor);

    private readonly List<QuickAction> quickActions = new()
    {
        new("Employees",   "bi bi-people-fill",    "/employee",   "bg-primary bg-opacity-10",   "text-primary"),
        new("Departments", "bi bi-building",        "/department", "bg-success bg-opacity-10",   "text-success"),
        new("Leave Types", "bi bi-calendar-range",  "/admin-leave-management", "bg-warning bg-opacity-25",   "text-warning"),
        new("Attendance",  "bi bi-clipboard-data",  "/attendance", "bg-info bg-opacity-10",      "text-info"),
        new("Roles",       "bi bi-shield-lock",     "/role",       "bg-danger bg-opacity-10",    "text-danger"),
        new("Users",       "bi bi-person-gear",     "/user",       "bg-secondary bg-opacity-10", "text-secondary"),
    };

    // ═══════════ LIFECYCLE ═══════════

    protected override async Task OnInitializedAsync()
    {
        SetGreeting();
        await LoadLeaveTypes();
        await LoadEmployees();
        await LoadLeaveRequests();
        BuildOverview();
    }

    private void SetGreeting()
    {
        var h = DateTime.Now.Hour;
        greeting = h switch
        {
            >= 5 and < 12 => "Good Morning",
            >= 12 and < 17 => "Good Afternoon",
            >= 17 and < 21 => "Good Evening",
            _ => "Good Night"
        };
    }

    // ═══════════ LOADERS ═══════════

    private async Task LoadLeaveTypes()
    {
        try
        {
            var res = await LeaveService.GetLeaveTypeAsync();
            leaveTypes = res?.IsSuccess == true && res.Data != null ? res.Data : new();
            leaveTypeNames = leaveTypes.ToDictionary(
                t => t.Id,
                t => FormatName(t.LeaveNameId.ToString()));
        }
        catch
        {
            leaveTypes = new();
            leaveTypeNames = new();
        }
    }

    private async Task LoadEmployees()
    {
        try
        {
            var res = await EmployeeService.GetEmployeesAsync();
            totalEmployees = res?.IsSuccess == true ? res.Data?.Count ?? 0 : 0;
        }
        catch { totalEmployees = 0; }
    }

    private async Task LoadLeaveRequests()
    {
        try
        {
            var res = await LeaveService.GetLeaveRequestAsync();
            allLeaveRequests = res?.IsSuccess == true && res.Data != null
                ? res.Data : new();

            var today = DateTime.Today;
            var monthStart = new DateTime(today.Year, today.Month, 1);

            onLeaveToday = allLeaveRequests.Count(r =>
                r.StatusId == Status.Approved
                && today >= r.StartDate.Date
                && today <= r.EndDate.Date);

            pendingCount = allLeaveRequests.Count(r => r.StatusId == Status.Pending);
            approvedTotal = allLeaveRequests.Count(r => r.StatusId == Status.Approved);
            rejectedTotal = allLeaveRequests.Count(r => r.StatusId == Status.Rejected);
            cancelledTotal = allLeaveRequests.Count(r => r.StatusId == Status.Cancelled);

            approvedThisMonth = allLeaveRequests.Count(r =>
                r.StatusId == Status.Approved && r.StartDate >= monthStart);

            pendingLeaveRequests = allLeaveRequests
                .Where(r => r.StatusId == Status.Pending)
                .OrderByDescending(r => r.StartDate)
                .ToList();

            recentApproved = allLeaveRequests
                .Where(r => r.StatusId == Status.Approved)
                .OrderByDescending(r => r.StartDate)
                .ToList();

            recentRejected = allLeaveRequests
                .Where(r => r.StatusId == Status.Rejected)
                .OrderByDescending(r => r.StartDate)
                .ToList();
        }
        catch { allLeaveRequests = new(); }
    }

    private void BuildOverview()
    {
        overviewItems = new()
        {
            new("Approved",  approvedTotal,  "bg-success",   "bg-success"),
            new("Pending",   pendingCount,   "bg-warning",   "bg-warning"),
            new("Rejected",  rejectedTotal,  "bg-danger",    "bg-danger"),
            new("Cancelled", cancelledTotal, "bg-secondary", "bg-secondary"),
        };
    }

    // ═══════════ ACTIONS ═══════════

    private async Task ApproveLeave(LeaveRequestViewModel req)
    {
        if (!await JsRuntime.InvokeAsync<bool>("confirm", "Approve this leave request?"))
            return;

        try
        {
            var res = await LeaveService.UpdateStatusLeaveAsync(req.Id, Status.Approved);
            if (res?.IsSuccess == true)
            {
                NotificationService.Success("Leave approved successfully.");
                await LoadLeaveRequests();
                BuildOverview();
            }
            else
                NotificationService.Error(res?.Message ?? "Failed to approve.");
        }
        catch (Exception ex)
        {
            NotificationService.Error(ex.Message ?? "Error approving leave.");
        }
    }

    private async Task RejectLeave(LeaveRequestViewModel req)
    {
        if (!await JsRuntime.InvokeAsync<bool>("confirm", "Reject this leave request?"))
            return;

        try
        {
            var res = await LeaveService.UpdateStatusLeaveAsync(req.Id, Status.Rejected);
            if (res?.IsSuccess == true)
            {
                NotificationService.Success("Leave rejected.");
                await LoadLeaveRequests();
                BuildOverview();
            }
            else
                NotificationService.Error(res?.Message ?? "Failed to reject.");
        }
        catch (Exception ex)
        {
            NotificationService.Error(ex.Message ?? "Error rejecting leave.");
        }
    }

    // ═══════════ HELPERS ═══════════

    private string GetLeaveTypeName(int id) =>
        leaveTypeNames.TryGetValue(id, out var n) ? n : $"Leave #{id}";

    private static string FormatName(string name) =>
        System.Text.RegularExpressions.Regex.Replace(name ?? "", "([A-Z])", " $1").Trim();

    private static string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[1][0]}".ToUpper()
            : parts[0][..Math.Min(2, parts[0].Length)].ToUpper();
    }

    private static int Pct(int value, int total) =>
        total > 0 ? (int)(value * 100.0 / total) : 0;
}