@page "/profile"

@using arna.HRMS.ClientServices.Admin.Department
@using arna.HRMS.ClientServices.Admin.Employee
@using arna.HRMS.ClientServices.Auth
@using arna.HRMS.Components.Loader
@using arna.HRMS.Models.ViewModels

@inject IEmployeeService EmployeeService
@inject IDepartmentService DepartmentService
@inherits AuthenticatedLayoutBase


@if (employee != null)
{
    <div class="profile-page">

        <!-- LEFT PROFILE -->
        <div class="card-box">
            <div class="avatar">
                @GetInitials()
                <span class="camera">
                    <i class="bi bi-camera"></i>
                </span>
            </div>

            <div class="left-info">
                <h4>@employee.FirstName @employee.LastName</h4>
                <div class="text-muted">@employee.Position</div>
                <span class="role-badge">@GetUserRole()</span>
            </div>

            <ul class="meta">
                <li><i class="bi bi-envelope"></i> @employee.Email</li>
                <li><i class="bi bi-telephone"></i> @employee.PhoneNumber</li>
                <li><i class="bi bi-building"></i> @employee.DepartmentName</li>
                <li><i class="bi bi-calendar"></i> Joined @employee.HireDate.ToString("MMMM yyyy")</li>
            </ul>
        </div>

        <!-- RIGHT PROFILE (FIXED SIZE) -->
        <div class="card-box profile-right-fixed">

            <div class="header">
                <div>
                    <h3>Profile Information</h3>
                    <small class="text-muted">Manage your personal details</small>
                </div>

                <button class="btn btn-outline-secondary btn-sm"
                        disabled="@(activeTab == ProfileTab.Others)"
                        @onclick="HandleEditClick">
                    <i class="bi bi-pencil"></i> Edit Profile
                </button>
            </div>

            <!-- TABS -->
            <div class="tabs">
                <button class="@(activeTab == ProfileTab.Personal ? "active" : "")"
                        @onclick="() => SetTab(ProfileTab.Personal)">
                    Personal
                </button>

                <button class="@(activeTab == ProfileTab.Work ? "active" : "")"
                        @onclick="() => SetTab(ProfileTab.Work)">
                    Work
                </button>

                <button class="@(activeTab == ProfileTab.Others ? "active" : "")"
                        @onclick="() => SetTab(ProfileTab.Others)">
                    Others
                </button>
            </div>

            <!-- TAB CONTENT (NO RESIZE) -->
            <div class="tab-content">

                @if (activeTab == ProfileTab.Personal)
                {
                    <div class="form-grid">
                        <div class="field"><label>First Name</label><input value="@employee.FirstName" readonly /></div>
                        <div class="field"><label>Last Name</label><input value="@employee.LastName" readonly /></div>
                        <div class="field"><label>Email</label><input value="@employee.Email" readonly /></div>
                        <div class="field"><label>Phone</label><input value="@employee.PhoneNumber" readonly /></div>
                        <div class="field full"><label>Address</label><input value="123 Main Street, SF" readonly /></div>
                    </div>
                }

                @if (activeTab == ProfileTab.Work)
                {
                    <div class="form-grid">
                        <div class="field"><label>Employee ID</label><input value="@employee.EmployeeNumber" readonly /></div>
                        <div class="field"><label>Department</label><input value="@employee.DepartmentName" readonly /></div>
                        <div class="field"><label>Department Code</label><input value="@employee.DepartmentCode" readonly /></div>
                        <div class="field"><label>Position</label><input value="@employee.Position" readonly /></div>
                        <div class="field"><label>Manager</label><input value="@employee.ManagerFullName" readonly /></div>
                        <div class="field"><label>Hire Date</label><input value="@employee.HireDate.ToShortDateString()" readonly /></div>
                    </div>
                }

                @if (activeTab == ProfileTab.Others)
                {
                    <div class="form-grid">
                        <div class="field"><label>Company</label><input value="Arna Technosoft" readonly /></div>
                        <div class="field"><label>Status</label><input value="@(employee.IsActive ? "Active" : "Inactive")" readonly /></div>
                        <div class="field"><label>Experience</label><input value="@experienceString" readonly /></div>
                        <div class="field"><label>Created At</label><input value="@employee.CreatedOn.ToShortDateString()" readonly /></div>
                    </div>
                }

            </div>
        </div>
    </div>
}
else
{
    <FullPageLoader />
}

@code {
    private EmployeeViewModel? employee;
    private string experienceString = "";
    private ProfileTab activeTab = ProfileTab.Personal;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var employeeId = GetEmployeeId();
        if (employeeId == 0) return;

        var result = await EmployeeService.GetEmployeeByIdAsync(employeeId);
        if (!result.IsSuccess || result.Data == null) return;

        employee = result.Data;

        var dept = await DepartmentService.GetDepartmentByIdAsync(employee.DepartmentId!.Value);
        if (dept?.Data != null)
        {
            employee.DepartmentName = dept.Data.Name;
            employee.DepartmentCode = dept.Data.Code;
        }

        CalculateExperience();
    }

    private void SetTab(ProfileTab tab) => activeTab = tab;

    private void HandleEditClick()
    {
        if (activeTab == ProfileTab.Others)
            return; // 🔒 frozen
    }

    private void CalculateExperience()
    {
        var doj = employee?.HireDate ?? DateTime.Today;
        var today = DateTime.Today;
        var years = today.Year - doj.Year;
        var months = today.Month - doj.Month;
        var anchorDate = doj.AddYears(years).AddMonths(months);
        int days = (today - anchorDate).Days;
        if (today.Day < doj.Day) months--;
        if (months < 0) { years--; months += 12; }
        experienceString = $"{years} Y {months} M {days} D";
    }

    private string GetInitials()
    {
        var f = employee?.FirstName?.FirstOrDefault();
        var l = employee?.LastName?.FirstOrDefault();
        return $"{f}{l}".ToUpper();
    }

    private enum ProfileTab { Personal, Work, Others }
}
