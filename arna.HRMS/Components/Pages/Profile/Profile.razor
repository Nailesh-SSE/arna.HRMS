@page "/profile"
@using arna.HRMS.ClientServices.Admin.Department
@using arna.HRMS.ClientServices.Admin.Employee
@using arna.HRMS.ClientServices.Admin.User
@using arna.HRMS.ClientServices.Auth
@using arna.HRMS.Components.Loader
@using arna.HRMS.Models.ViewModels

@inject IEmployeeService EmployeeService
@inject IDepartmentService DepartmentService
@inject IUsersService UserService
@inherits AuthenticatedLayoutBase

@if (displayModel == null)
{
    <FullPageLoader />
}
else
{
    <div class="profile-page">
        <div class="card-box">
            <div class="avatar">
                @Initials
                <span class="camera"><i class="bi bi-camera"></i></span>
            </div>

            <div class="left-info">
                <h4>@displayModel.FullName</h4>
                @if (!string.IsNullOrEmpty(displayModel.Position))
                {
                    <div class="text-muted">@displayModel.Position</div>
                }
                <span class="role-badge">@GetUserRole()</span>
            </div>

            <ul class="meta">
                <li><i class="bi bi-envelope"></i> @displayModel.Email</li>
                @if (!string.IsNullOrEmpty(displayModel.PhoneNumber))
                {
                    <li><i class="bi bi-telephone"></i> @displayModel.PhoneNumber</li>
                }
                @if (!string.IsNullOrEmpty(displayModel.DepartmentName))
                {
                    <li><i class="bi bi-building"></i> @displayModel.DepartmentName</li>
                }
                <li><i class="bi bi-calendar"></i> Joined @displayModel.CreatedOn.ToString("MMMM yyyy")</li>
            </ul>
        </div>

        @if (isFullEmployeeProfile)
        {
            <div class="card-box profile-right-fixed">
                <div class="header">
                    <div>
                        <h3>Profile Information</h3>
                        <small class="text-muted">Manage your personal details</small>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm"
                            disabled="@(activeTab == ProfileTab.Others)"
                            @onclick="HandleEditClick">
                        <i class="bi bi-pencil"></i> Edit Profile
                    </button>
                </div>

                <div class="tabs">
                    @foreach (ProfileTab tab in Enum.GetValues(typeof(ProfileTab)))
                    {
                        <button class="@(activeTab == tab ? "active" : "")" @onclick="() => activeTab = tab">
                            @tab.ToString()
                        </button>
                    }
                </div>

                <div class="tab-content">
                    <div class="form-grid">
                        @switch (activeTab)
                        {
                            case ProfileTab.Personal:
                                <div class="field"><label>First Name</label><input value="@displayModel.FirstName" readonly /></div>
                                <div class="field"><label>Last Name</label><input value="@displayModel.LastName" readonly /></div>
                                <div class="field"><label>Email</label><input value="@displayModel.Email" readonly /></div>
                                <div class="field"><label>Phone</label><input value="@displayModel.PhoneNumber" readonly /></div>
                                <div class="field full"><label>Address</label><input value="123 Main Street, SF" readonly /></div>
                                break;

                            case ProfileTab.Work:
                                <div class="field"><label>Employee ID</label><input value="@displayModel.EmployeeNumber" readonly /></div>
                                <div class="field"><label>Department</label><input value="@displayModel.DepartmentName" readonly /></div>
                                <div class="field"><label>Position</label><input value="@displayModel.Position" readonly /></div>
                                <div class="field"><label>Manager</label><input value="@displayModel.ManagerFullName" readonly /></div>
                                <div class="field"><label>Hire Date</label><input value="@displayModel.HireDate?.ToShortDateString()" readonly /></div>
                                break;

                            case ProfileTab.Others:
                                <div class="field"><label>Company</label><input value="Arna Technosoft" readonly /></div>
                                <div class="field"><label>Status</label><input value="@(displayModel.IsActive ? "Active" : "Inactive")" readonly /></div>
                                <div class="field"><label>Experience</label><input value="@ExperienceString" readonly /></div>
                                <div class="field"><label>Created At</label><input value="@displayModel.CreatedOn.ToShortDateString()" readonly /></div>
                                break;
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private ProfileViewModel? displayModel;
    private ProfileTab activeTab = ProfileTab.Personal;
    private bool isFullEmployeeProfile => displayModel?.IsEmployee ?? false;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        var employeeId = GetEmployeeId();

        if (employeeId > 0)
        {
            var result = await EmployeeService.GetEmployeeByIdAsync(employeeId);
            if (result.IsSuccess && result.Data != null)
            {
                displayModel = new ProfileViewModel(result.Data);

                var dept = await DepartmentService.GetDepartmentByIdAsync(result.Data.DepartmentId ?? 0);
                if (dept?.Data != null)
                {
                    displayModel.DepartmentName = dept.Data.Name;
                    displayModel.DepartmentCode = dept.Data.Code;
                }
            }
        }
        else
        {
            var userId = GetUserId();
            var user = await UserService.GetUserByIdAsync(userId);
            if (user?.Data != null)
            {
                displayModel = new ProfileViewModel(user.Data);
            }
        }
    }

    private string Initials => $"{(displayModel?.FirstName?.FirstOrDefault() ?? 'U')}{(displayModel?.LastName?.FirstOrDefault() ?? ' ')}".Trim().ToUpper();

    private string ExperienceString
    {
        get
        {
            var doj = displayModel?.HireDate ?? DateTime.Today;
            var today = DateTime.Today;
            var years = today.Year - doj.Year;
            var months = today.Month - doj.Month;
            var anchorDate = doj.AddYears(years).AddMonths(months);
            int days = (today - anchorDate).Days;
            if (today.Day < doj.Day) months--;
            if (months < 0) { years--; months += 12; }
            return $"{years} Y {months} M {days} D";
        }
    }

    private void HandleEditClick() => _ = activeTab == ProfileTab.Others ? null : "Trigger Edit Logic";

    private enum ProfileTab { Personal, Work, Others }
}