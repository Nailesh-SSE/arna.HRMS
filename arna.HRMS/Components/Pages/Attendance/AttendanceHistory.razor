@page "/attendance"

@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using arna.HRMS.Models.DTOs
@using arna.HRMS.Models.ViewModels
@using arna.HRMS.ClientServices.Attendance

@inject IAttendanceService AttendanceService
@inject AuthenticationStateProvider AuthProvider

<div class="attendance-dashboard">

    <!-- HEADER -->
    <div class="dashboard-header">
        <div>
            <h2>Attendance Overview</h2>
            <p class="text-muted">View and track your monthly attendance</p>
        </div>

        <div class="month-picker">
            <label>Month</label>
            <input type="month"
                   value="@SelectedMonth"
                   @onchange="OnMonthChange" />
        </div>
    </div>

    <!-- SUMMARY -->
    <div class="summary-grid">
        @foreach (var item in SummaryCards)
        {
            <div class="summary-tile">
                <span class="label">@item.Label</span>
                <span class="count @item.Text">@item.Count</span>
            </div>
        }
    </div>

    <!-- TOTAL WORKING HOURS -->
    <div class="total-hours-card mt-3 mb-3">
        <strong>Total Working Hours:</strong>
        <span>@TotalWorkingHours.ToString("0.00") hrs</span>
    </div>

    <!-- TABLE -->
    <div class="table-card">
        <div class="table-title">Monthly Attendance</div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th @onclick="() => SortBy(nameof(AttendanceViewModel.Date))">
                            Date @SortIcon(nameof(AttendanceViewModel.Date))
                        </th>
                        <th>Day</th>
                        <th>Clock In</th>
                        <th>Clock Out</th>
                        <th>Working Hours</th>
                        <th @onclick="() => SortBy(nameof(AttendanceViewModel.Status))">
                            Status @SortIcon(nameof(AttendanceViewModel.Status))
                        </th>
                        <th></th>
                    </tr>
                </thead>

                <tbody>
                    @if (FilteredAttendance.Any())
                    {
                        @foreach (var item in FilteredAttendance)
                        {
                            <tr>
                                <td>@item.Date.ToString("dd MMM yyyy")</td>
                                <td>@item.Day</td>
                                <td>@(item.ClockIn?.ToString(@"hh\:mm") ?? "-")</td>
                                <td>@(item.ClockOut?.ToString(@"hh\:mm") ?? "-")</td>
                                <td>@(item.TotalHours.ToString("0.00") ?? "-")</td>
                                <td>
                                    <span class="status-pill status-@item.Status.ToLower()">
                                        @item.Status
                                    </span>
                                </td>
                                <td class="text-primary">Detail</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">
                                No attendance data found
                            </td>
                        </tr>
                    }
                </tbody>

            </table>
        </div>
    </div>

</div>

@code {

    private List<MonthlyAttendanceDto> AttendanceData = new();
    private List<MonthlyAttendanceDto> FilteredAttendance = new();
    private List<AttendenceSummaryCard> SummaryCards = new();

    private double TotalWorkingHours;
    private string SelectedMonth = DateTime.Now.ToString("yyyy-MM");

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthData(SelectedMonth);
    }

    private async Task OnMonthChange(ChangeEventArgs e)
    {
        SelectedMonth = e.Value?.ToString() ?? SelectedMonth;
        await LoadMonthData(SelectedMonth);
    }

    private async Task LoadMonthData(string month)
    {
        if (string.IsNullOrWhiteSpace(month)) return;

        var parts = month.Split('-');
        int year = int.Parse(parts[0]);
        int selectedMonth = int.Parse(parts[1]);

        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var employeeId = user.FindFirst("EmployeeId")?.Value;

        AttendanceData = await AttendanceService.GetAttendanceByMonthAsync(year, selectedMonth, Convert.ToInt32(employeeId));

        FilteredAttendance = AttendanceData;

        TotalWorkingHours = FilteredAttendance.Sum(x => x.TotalHours);

        ApplySorting();

        SummaryCards = AttendanceSummaryBuilder.Build(FilteredAttendance);

        ApplySorting();

        SummaryCards = AttendanceSummaryBuilder.Build(FilteredAttendance);
    }

    private string SortColumn = nameof(MonthlyAttendanceDto.Date);
    private bool SortAscending = true;

    private void SortBy(string column)
    {
        SortAscending = SortColumn == column ? !SortAscending : true;
        SortColumn = column;
        ApplySorting();
    }

    private void ApplySorting()
    {
        FilteredAttendance = SortColumn switch
        {
            nameof(MonthlyAttendanceDto.Date) =>
                SortAscending
                    ? FilteredAttendance.OrderBy(x => x.Date).ToList()
                    : FilteredAttendance.OrderByDescending(x => x.Date).ToList(),

            nameof(MonthlyAttendanceDto.Status) =>
                SortAscending
                    ? FilteredAttendance.OrderBy(x => x.Status).ToList()
                    : FilteredAttendance.OrderByDescending(x => x.Status).ToList(),

            _ => FilteredAttendance
        };
    }

    private string SortIcon(string column)
        => SortColumn == column ? (SortAscending ? "▲" : "▼") : "";
}
