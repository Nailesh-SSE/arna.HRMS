@page "/attendance"

@using arna.HRMS.ClientServices.Attendance
@using arna.HRMS.ClientServices.Auth
@using arna.HRMS.Components.Common
@using arna.HRMS.Components.Pages.Attendance.AttendanceRequest
@using arna.HRMS.Components.Pages.Attendance.MonthYearAndToggle
@using arna.HRMS.Components.Pages.Attendance.Summary
@using arna.HRMS.Components.Pages.Attendance.TableAndCalendar
@using arna.HRMS.Components.lib.components.ui.Forms

@inject IAttendanceService AttendanceService
@inject AttendanceState State
@inherits AuthenticatedLayoutBase

<FullPageLoader Visible="@isLoading" />

<div class="attendance-dashboard">

    @if (!isLoading)
    {
        <div class="mt-5 dashboard-header">
            <div>
                <div class="d-flex align-items-center position-relative">
                    <!-- Title -->
                    <h2 class="mb-0">
                        Attendance Overview
                    </h2>

                    <!-- Right Button -->
                    <div class="ms-auto">
                        <AppButton Text="Request"
                                   ButtonClass="btn btn-dark px-5"
                                   OnClick="OpenDrawer" />
                    </div>
                </div>

                <p class="text-muted mt-2">
                    View and track your monthly attendance
                </p>
            </div>
        </div>

        <AttendanceSummary SummaryCards="State.SummaryCards" />

        <div class="hours-kpi">
            <div class="hours-info">
                <span class="hours-label">Total Working Hours</span>
            </div>

            <div class="hours-value">
                @State.TotalWorkingHours.ToString(@"hh\:mm")
                <span class="unit">hrs</span>
            </div>
        </div>

        <div class="select-month-view-toggle">
            <SelectMonthAndYear Year="@State.Year"
                                Month="@State.Month"
                                OnChange="OnMonthSelected" />

            <AttendanceViewToggle ActiveView="@State.ViewMode"
                                  OnChange="SetView" />
        </div>

        @if (State.ViewMode == AttendanceState.TABLE)
        {
            <AttendanceTable AttendanceList="State.AttendanceList" />
        }

        @if (State.ViewMode == AttendanceState.CALENDAR)
        {
            <AttendanceCalendar Year="@State.Year"
                                Month="@State.Month"
                                AttendanceLookup="State.AttendanceLookup" />
        }
    }

    <!-- Drawer (ALWAYS rendered) -->
    <AttendanceRequestDrawer IsOpen="@isDrawerOpen"
                             IsOpenChanged="@(v => isDrawerOpen = v)"
                             Title="Attendance Request" />
</div>

@code {
    private bool isLoading = true;
    private bool hasLoaded = false;
    private bool isDrawerOpen = false;

    private void OpenDrawer()
    {
        isDrawerOpen = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || hasLoaded)
            return;

        hasLoaded = true;

        try
        {
            if (!IsAuthentication())
                return;

            if (string.IsNullOrWhiteSpace(State.SelectedMonth))
            {
                var now = DateTime.Today;
                State.Year = now.Year;
                State.Month = now.Month;
                State.SelectedMonth = $"{now.Year}-{now.Month:D2}";
            }
            else
            {
                State.ParseMonth();
            }

            await LoadData();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnMonthSelected((int year, int month) value)
    {
        State.Year = value.year;
        State.Month = value.month;
        State.SelectedMonth = $"{value.year}-{value.month:D2}";
        await LoadData();
    }

    private async Task LoadData()
    {
        var empId = GetEmployeeId();
        if (empId == 0)
            return;

        State.AttendanceList =
            await AttendanceService.GetAttendanceByMonthAsync(
                State.Year,
                State.Month,
                empId
            );

        State.AttendanceLookup =
            State.AttendanceList
                .Where(x => x.Date.Year == State.Year &&
                            x.Date.Month == State.Month)
                .ToDictionary(x => x.Date);

        State.TotalWorkingHours =
            State.AttendanceList.Aggregate(
                TimeSpan.Zero,
                (total, item) => total + item.TotalHours
            );


        State.SummaryCards =
            AttendanceSummaryBuilder.Build(State.AttendanceList);
    }

    private void SetView(string mode)
        => State.ViewMode = mode;
}

