@page "/attendance"

@using Microsoft.AspNetCore.Components.Authorization
@using arna.HRMS.ClientServices.Attendance
@using arna.HRMS.Models.DTOs
@using arna.HRMS.Models.ViewModels
@using arna.HRMS.Components.Pages.Attendance

@inject IAttendanceService AttendanceService
@inject AuthenticationStateProvider AuthProvider
@inject AttendanceState State
@inject NavigationManager Navigation

<div class="attendance-dashboard">

    <div class="dashboard-header">
        <div>
            <h2>Attendance Overview</h2>
            <p class="text-muted">View and track your monthly attendance</p>
        </div>
    </div>

    <AttendanceSummary SummaryCards="State.SummaryCards" />

    <div class="hours-kpi">
        <div class="hours-info">
            <span class="hours-label">Total Working Hours</span>
        </div>

        <div class="hours-value">
            @State.TotalWorkingHours.ToString("0.00")
            <span class="unit">hrs</span>
        </div>
    </div>

    <div class="select-month-view-toggle">

        <SelectMonthAndYear Year="@State.Year"
                            Month="@State.Month"
                            OnChange="OnMonthSelected" />

        <AttendanceViewToggle ActiveView="@State.ViewMode"
                              OnChange="SetView" />
    </div>

    @if (State.ViewMode == AttendanceState.TABLE)
    {
        <AttendanceTable AttendanceList="State.AttendanceList" />
    }

    @if (State.ViewMode == AttendanceState.CALENDAR)
    {
        <AttendanceCalendar Year="@State.Year"
                            Month="@State.Month"
                            AttendanceLookup="State.AttendanceLookup" />
    }
</div>

@code {

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(State.SelectedMonth))
        {
            var now = DateTime.Today;
            State.Year = now.Year;
            State.Month = now.Month;
            State.SelectedMonth = $"{now.Year}-{now.Month:D2}";
        }
        else
        {
            State.ParseMonth();
        }

        await LoadData();
    }

    private async Task OnMonthSelected((int year, int month) value)
    {
        State.Year = value.year;
        State.Month = value.month;
        State.SelectedMonth = $"{value.year}-{value.month:D2}";
        await LoadData();
    }

    private async Task LoadData()
    {
        var auth = await AuthProvider.GetAuthenticationStateAsync();
        var isAuthenticated = auth.User.Identity?.IsAuthenticated ?? false;

        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        int empId = int.Parse(auth.User.FindFirst("EmployeeId")!.Value);

        State.AttendanceList = await AttendanceService
            .GetAttendanceByMonthAsync(State.Year, State.Month, empId);

        State.AttendanceLookup =
        State.AttendanceList
             .Where(x => x.Date.Year == State.Year &&
                         x.Date.Month == State.Month)
             .ToDictionary(x => x.Date);

        State.TotalWorkingHours =
            State.AttendanceList.Sum(x => x.TotalHours);

        State.SummaryCards =
            AttendanceSummaryBuilder.Build(State.AttendanceList);
    }

    private void SetView(string mode)
        => State.ViewMode = mode;
}
