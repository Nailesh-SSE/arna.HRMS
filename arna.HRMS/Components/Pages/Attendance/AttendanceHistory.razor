@page "/attendance"

@using Microsoft.AspNetCore.Components.Authorization
@using arna.HRMS.ClientServices.Attendance
@using arna.HRMS.Models.DTOs
@using arna.HRMS.Models.ViewModels
@using arna.HRMS.Components.Pages.Attendance

@inject IAttendanceService AttendanceService
@inject AuthenticationStateProvider AuthProvider
@inject AttendanceState State

<div class="attendance-dashboard">

    <!-- HEADER -->
    <div class="dashboard-header">
        <div>
            <h2>Attendance Overview</h2>
            <p class="text-muted">View and track your monthly attendance</p>
        </div>

        <div class="month-picker">
            <label>Month</label>
            <input type="month"
                   value="@State.SelectedMonth"
                   @onchange="OnMonthChange" />
        </div>
    </div>

    <!-- SUMMARY -->
    <AttendanceSummary SummaryCards="State.SummaryCards" />

    <!-- TOTAL HOURS -->
    <div class="total-hours-card">
        <strong>Total Working Hours:</strong>
        <span>@State.TotalWorkingHours.ToString("0.00") hrs</span>
    </div>

    <!-- VIEW TOGGLE -->
    <div class="section-header">
        <h4>Monthly Attendance</h4>
        <AttendanceViewToggle ActiveView="@State.ViewMode"
                    OnChange="SetView" />
    </div>

    <!-- TABLE -->
    @if (State.ViewMode == AttendanceState.TABLE)
    {
        <AttendanceTable AttendanceList="State.AttendanceList" />
    }

    <!-- CALENDAR -->
    @if (State.ViewMode == AttendanceState.CALENDAR)
    {
        <AttendanceCalendar Year="@State.Year"
                            Month="@State.Month"
                            AttendanceLookup="State.AttendanceLookup" />
    }

</div>

@code {

    protected override async Task OnInitializedAsync()
    {
        State.ParseMonth();
        await LoadData();
    }

    private async Task OnMonthChange(ChangeEventArgs e)
    {
        State.SelectedMonth = e.Value?.ToString() ?? State.SelectedMonth;
        State.ParseMonth();
        await LoadData();
    }

    private async Task LoadData()
    {
        var auth = await AuthProvider.GetAuthenticationStateAsync();
        int empId = int.Parse(auth.User.FindFirst("EmployeeId")!.Value);

        State.AttendanceList = await AttendanceService
            .GetAttendanceByMonthAsync(State.Year, State.Month, empId);

        State.AttendanceLookup =
            State.AttendanceList.ToDictionary(x => x.Date);

        State.TotalWorkingHours =
            State.AttendanceList.Sum(x => x.TotalHours);

        State.SummaryCards =
            AttendanceSummaryBuilder.Build(State.AttendanceList);
    }

    private void SetView(string mode)
        => State.ViewMode = mode;
}
