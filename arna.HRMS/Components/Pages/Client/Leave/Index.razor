@page "/leaverequest"

@using arna.HRMS.ClientServices.Leave
@using arna.HRMS.ClientServices.Common
@using arna.HRMS.ClientServices.Auth
@using arna.HRMS.Components.Loader
@using arna.HRMS.Components.lib.components.ui.Model
@using arna.HRMS.Models.ViewModels.Leave
@using arna.HRMS.Models.Dropdown
@using arna.HRMS.Models.Enums

@inject ILeaveService LeaveService
@inject NotificationService NotificationService
@inject IJSRuntime JsRuntime

@inherits AuthenticatedLayoutBase

<FullPageLoader Visible="isLoading" />

@if (!isLoading)
{
    <PageTitle>Leave Management</PageTitle>

    <div class="leave-management-container">

        <div class="leave-header d-flex justify-content-between align-items-center mb-3">
            <h1>Leave Management</h1>

            <button class="btn btn-primary btn-lg"
                    @onclick="OpenCreateModal">
                + Apply Leave
            </button>
        </div>

        <LeaveSummaries Summaries="summaries"
                        LeaveTypes="leaveTypes" />

        <LeaveRequestList Requests="requests"
                          OnCancel="HandleCancelRequest"
                          OnEdit="HandleEditRequest" />
    </div>

    <LeaveRequestForm ShowModal="showModal"
                      ShowModalChanged="OnModalChanged"
                      SelectedRequest="selectedRequest"
                      LeaveOptions="leaveOptions"
                      IsDateDisabled="IsDateBlocked"
                      OnSaved="OnRequestSaved" />
}

@code {

    private bool isLoading = true;
    private bool showModal;

    private LeaveRequestViewModel? selectedRequest;

    private List<LeaveRequestViewModel> requests = new();
    private List<LeaveTypeViewModel> leaveTypes = new();
    private List<SelectOption> leaveOptions = new();
    private List<LeaveBalanceViewModel> summaries = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadUserAsync();

        await LoadLeaveTypes();
        await LoadRequests();
        await LoadBalances();

        isLoading = false;
    }

    private void OpenCreateModal()
    {
        selectedRequest = null; 
        showModal = true;
    }

    private void HandleEditRequest(int id)
    {
        selectedRequest = requests.FirstOrDefault(x => x.Id == id);
        showModal = true;
    }

    private Task OnModalChanged(bool value)
    {
        showModal = value;
        return Task.CompletedTask;
    }

    private async Task LoadLeaveTypes()
    {
        var result = await LeaveService.GetLeaveTypeAsync();
        if (result?.IsSuccess == true && result.Data != null)
            leaveTypes = result.Data;
    }

    private async Task LoadRequests()
    {
        var result = await LeaveService.GetLeaveRequestByEmployee(GetEmployeeId());
        if (result?.IsSuccess == true && result.Data != null)
            requests = result.Data;
    }

    private async Task LoadBalances()
    {
        var result = await LeaveService.GetLeaveRequestByFilterAsync(
            Status.Approved,
            GetEmployeeId());

        var approvedLeaves = result?.IsSuccess == true && result.Data != null
            ? result.Data
            : new List<LeaveRequestViewModel>();

        var usedByType = approvedLeaves
            .GroupBy(x => x.LeaveTypeId)
            .ToDictionary(
                g => g.Key,
                g => g.Sum(x => x.LeaveDays) // ✅ CORRECT
            );

        summaries = leaveTypes.Select(type =>
        {
            usedByType.TryGetValue(type.Id, out var usedDays);

            return new LeaveBalanceViewModel
            {
                LeaveTypeId = type.Id,
                LeaveTypeName = type.LeaveNameId.ToString(),
                TotalDays = type.MaxPerYear,
                UsedDays = usedDays
            };
        }).ToList();

        BuildLeaveOptions();
    }

    private void BuildLeaveOptions()
    {
        leaveOptions = leaveTypes.Select(type =>
        {
            var balance = summaries.FirstOrDefault(x => x.LeaveTypeId == type.Id);
            var remaining = balance?.RemainingDays ?? 0;

            return new SelectOption
            {
                Value = type.Id.ToString(),
                Text = $"{type.LeaveNameId} ({remaining} left)",
                IsDisabled = remaining == 0
            };
        }).ToList();
    }

    private async Task OnRequestSaved()
    {
        await LoadRequests();
        await LoadBalances();
    }

    private async Task HandleCancelRequest(int leaveRequestId)
    {
        if (!await JsRuntime.InvokeAsync<bool>("confirm", "Cancel this request?"))
            return;

        var result = await LeaveService.UpadteLeaverequestStatusCancle(
            leaveRequestId,
            GetEmployeeId());

        if (result?.IsSuccess == true)
        {
            NotificationService.Success("Leave cancelled successfully.");
            await LoadRequests();
            await LoadBalances();
        }
    }

    private bool IsDateBlocked(DateTime date)
    {
        return requests.Any(r =>
            r.EmployeeId == GetEmployeeId()
            && (r.StatusId == Status.Pending || r.StatusId == Status.Approved)
            && date >= r.StartDate.Date
            && date <= r.EndDate.Date);
    }
}
