@using arna.HRMS.Models.ViewModels.Leave
@using arna.HRMS.Models.Enums
@using arna.HRMS.Services
@using arna.HRMS.Services.Auth

@inject ILeaveService LeaveService
@inherits AuthenticatedLayoutBase

<div class="card border-0 shadow-sm rounded-3 mb-4">
    <div class="card-header bg-transparent border-bottom py-3">
        <h6 class="fw-semibold mb-0">
            <i class="bi bi-pie-chart text-primary me-2"></i>
             Leave Balance
        </h6>
    </div>
    <div class="card-body">

        @if (summaries.Count == 0)
        {
            <div class="text-center text-muted py-3">
                <i class="bi bi-info-circle fs-4 d-block mb-2 opacity-50"></i>
                No leave configuration found.
            </div>
        }
        else
        {
            <div class="row g-3">
                @foreach (var (s, idx) in summaries.Select((item, i) => (item, i)))
                {
                    var color = GetColor(idx);

                    <div class="col-sm-6 col-lg-4 col-xl-3">
                        <div class="card border-0 rounded-3 h-100
                                            @(s.RemainingDays == 0 ? "bg-light" : "")
                                            leave-balance-card">
                            <div class="card-body">

                                <div class="d-flex justify-content-between
                                                    align-items-start mb-2">
                                    <div>
                                        <div class="leave-type-icon bg-@color
                                                            bg-opacity-10 mb-2">
                                            <i class="bi bi-calendar-check
                                                              text-@color fs-5"></i>
                                        </div>
                                        <h6 class="fw-bold mb-1">@s.LeaveTypeName</h6>
                                        <div class="text-muted small">
                                            @s.UsedDays used &bull;
                                            @s.RemainingDays remaining
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fs-3 fw-bold text-@color">
                                            @s.RemainingDays
                                        </div>
                                        <div class="small text-muted">
                                            of @s.TotalDays days
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <div class="progress"
                                         style="height:8px; border-radius:8px;
                                                        background:#eef2ff;">
                                        <div class="progress-bar @GetProgressClass(s)"
                                             role="progressbar"
                                             style="width:@GetPercent(s)%;
                                                            border-radius:8px;">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-1">
                                        <small class="text-muted">
                                            Used: @s.UsedDays
                                        </small>
                                        <small class="text-muted">
                                            @GetPercent(s)%
                                        </small>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                }
            </div>
        }

    </div>
</div>

@code {

    private List<LeaveBalanceViewModel> summaries = new();
    private List<LeaveTypeViewModel> leaveTypes = new();
    private List<LeaveRequestViewModel> employeeRequests = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadDataAsync();
    }

    public async Task RefreshAsync()
    {
        await LoadDataAsync();
        StateHasChanged();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;

        try
        {
            var employeeId = GetEmployeeId();

            var typeResult = await LeaveService.GetLeaveTypesAsync();
            leaveTypes = typeResult?.IsSuccess == true && typeResult.Data != null
                ? typeResult.Data
                : new();

            var reqResult = await LeaveService.GetLeaveRequestsByEmployeeAsync(employeeId);
            employeeRequests = reqResult?.IsSuccess == true && reqResult.Data != null
                ? reqResult.Data
                : new();

            summaries = BuildBalanceSummaries();
        }
        catch
        {
            summaries = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    private List<LeaveBalanceViewModel> BuildBalanceSummaries()
    {
        if (leaveTypes == null || !leaveTypes.Any())
            return new();

        var approvedRequests = employeeRequests
            .Where(r => r.StatusId == Status.Approved)
            .ToList();

        return leaveTypes
            .Where(lt => lt.IsActive)
            .Select(lt =>
            {
                var usedDays = approvedRequests
                    .Where(r => r.LeaveTypeId == lt.Id)
                    .Sum(r => r.LeaveDays);

                return new LeaveBalanceViewModel
                {
                    LeaveTypeId = lt.Id,
                    LeaveTypeName = FormatEnum(lt.LeaveNameId.ToString()),
                    TotalDays = lt.MaxPerYear,
                    UsedDays = usedDays,
                    // RemainingDays = RemainingDays
                };
            })
            .ToList();
    }

    private int GetPercent(LeaveBalanceViewModel s) =>
        s.TotalDays == 0 ? 0 : (int)((s.UsedDays * 100.0) / s.TotalDays);

    private static string GetColor(int idx) => (idx % 5) switch
    {
        0 => "primary",
        1 => "success",
        2 => "info",
        3 => "warning",
        4 => "danger",
        _ => "secondary"
    };

    private string GetProgressClass(LeaveBalanceViewModel s) =>
        GetPercent(s) switch
        {
            >= 80 => "bg-danger",
            >= 60 => "bg-warning",
            _ => "bg-success"
        };

    private static string FormatEnum(string name) =>
        System.Text.RegularExpressions.Regex.Replace(
            name ?? "", "([a-z])([A-Z])", "$1 $2");
}