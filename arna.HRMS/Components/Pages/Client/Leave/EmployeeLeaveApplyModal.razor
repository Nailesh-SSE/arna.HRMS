@using Microsoft.AspNetCore.Components.Forms
@using arna.HRMS.ClientServices.Auth
@using arna.HRMS.ClientServices.Leave
@using arna.HRMS.ClientServices.Common
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Components.lib.components.ui.Model
@using arna.HRMS.Models.ViewModels.Leave
@using arna.HRMS.Models.Enums

@inject ILeaveService LeaveService
@inject NotificationService NotificationService
@inherits AuthenticatedLayoutBase

<div style="pointer-events:@(ShowModal ? "auto" : "none")">
    @if (ShowModal)
    {
        <div class="custom-backdrop" @onclick="Close"></div>

            <div class="modal fade show d-block" tabindex="-1" style="z-index:1055">
            <div class="modal-dialog modal-dialog-centered modal-md">
                <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                    <div class="modal-header bg-primary bg-gradient text-white px-4 py-3 border-0">
                        <h5 class="modal-title fw-semibold d-flex align-items-center gap-2 mb-0">
                            <i class="bi @(IsEditMode ? "bi-pencil-square" : "bi-send-plus")"></i>
                            @(IsEditMode ? "Update Leave" : "Apply Leave")
                        </h5>
                        <button type="button" class="btn-close btn-close-white"
                                @onclick="Close"></button>
                    </div>

                    <EditForm EditContext="editContext" OnValidSubmit="Save">
                        <DataAnnotationsValidator />

                        <div class="modal-body px-4 pt-4 pb-3">

                            <!-- Leave Type -->
                            <div class="mb-3">
                                <AppSelect Label="Leave Type *"
                                           Options="LeaveOptions"
                                           Value="@(model.LeaveTypeId == 0 ? "" : model.LeaveTypeId.ToString())"
                                           ValueChanged="OnLeaveTypeChanged"
                                           ValidationExpression="() => model.LeaveTypeId"
                                           Placeholder="Select Leave..." />
                                </div>

                            <!-- Date Range -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <AppDatePicker Label="Start Date *"
                                                   Value="@model.StartDate.Date"
                                                   ValueChanged="OnStartChanged"
                                                   ValidationExpression="() => model.StartDate"
                                                   IsDateDisabled="IsDateDisabled" />
                                </div>
                                <div class="col-md-6">
                                    <AppDatePicker Label="End Date *"
                                                   Value="@model.EndDate.Date"
                                                   ValueChanged="OnEndChanged"
                                                   ValidationExpression="() => model.EndDate"
                                                   IsDateDisabled="IsDateDisabled" />
                                    </div>
                                </div>

                            <!-- Total Days Info -->
                            @* @if (model.StartDate != default && model.EndDate != default)
                            {
                                <div class="alert alert-info bg-info bg-opacity-10 border-0
                                                    rounded-3 py-2 mb-3">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Total Days: <strong>@model.LeaveDays</strong>
                                </div>
                            } *@

                            <!-- Reason -->
                            <div class="mb-1">
                                 <AppTextArea Label="Reason *"
                                      Rows="4"
                                      Value="@model.Reason"
                                      ValueChanged="OnReasonChanged"
                                      ValidationExpression="() => model.Reason" />
                            </div>
                    </div>

                    <!-- Footer -->
                    <div class="modal-footer border-top bg-light px-4 py-3
                                    d-flex justify-content-end gap-2">
                        <AppButton Type="button"
                            ButtonClass="btn btn-outline-secondary rounded-pill px-4"
                                Onclick="Close">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </AppButton>
                        <AppButton Type="submit"
                                ButtonClass="btn btn-primary rounded-pill px-4 shadow-sm"
                                disabled="@isSubmitting">
                            @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                else
                                {
                                    <i class="bi @(IsEditMode
                                            ? "bi-arrow-repeat" : "bi-send") me-1"></i>
                                    }
                                @(IsEditMode ? "Update" : "Submit")
                            </AppButton>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    }
</div>

@code {

    [Parameter] public bool ShowModal { get; set; }
    [Parameter] public EventCallback<bool> ShowModalChanged { get; set; }

    [Parameter] public LeaveRequestViewModel? SelectedRequest { get; set; }
    [Parameter] public List<SelectOption> LeaveOptions { get; set; } = new();
    [Parameter] public Func<DateTime, bool>? IsDateDisabled { get; set; }

    [Parameter] public EventCallback OnSaved { get; set; }

    private LeaveRequestViewModel model = new();
    private EditContext editContext = null!;
    private bool isSubmitting;

    private bool IsEditMode => SelectedRequest != null;

    protected override void OnParametersSet()
    {
        if (ShowModal == false)
            return;

        if (SelectedRequest != null)
        {
            model = Clone(SelectedRequest);
        }
        else
        {
            model = new LeaveRequestViewModel
            {
                EmployeeId = GetEmployeeId(),
                StartDate = DateTime.Today,
                EndDate = DateTime.Today
            };
        }

        editContext = new EditContext(model);
    }

    private async Task Save()
    {
        isSubmitting = true;

        if (IsEditMode)
        {
            var result = await LeaveService.UpdateLeaveRequestAsync(model.Id, model);
            if (result?.IsSuccess == true)
                NotificationService.Success("Leave updated successfully.");
        }
        else
        {
            var result = await LeaveService.CreateLeaveRequestAsync(model);

            if (result?.IsSuccess == true)
            {
                NotificationService.Success("Leave submitted successfully.");
                await Close();
                await OnSaved.InvokeAsync();
            }
            else
            {
                NotificationService.Error(result?.Message ?? "Failed to submit leave.");
            }
        }

        isSubmitting = false;
        await Close();
        await OnSaved.InvokeAsync();
    }

    private async Task Close()
    {
        await ShowModalChanged.InvokeAsync(false);
    }

    private Task OnLeaveTypeChanged(string? v)
    {
        model.LeaveTypeId = int.TryParse(v, out var id) ? id : 0;
        editContext.NotifyFieldChanged(
            new FieldIdentifier(model, nameof(model.LeaveTypeId)));
        return Task.CompletedTask;
    }

    private Task OnStartChanged(DateTime? d)
    {
        model.StartDate = (d ?? DateTime.Today).Date;

        editContext.NotifyFieldChanged(
            new FieldIdentifier(model, nameof(model.StartDate)));

        StateHasChanged();

        return Task.CompletedTask;
    }

    private Task OnEndChanged(DateTime? d)
    {
        model.EndDate = (d ?? DateTime.Today).Date;

        editContext.NotifyFieldChanged(
            new FieldIdentifier(model, nameof(model.EndDate)));

        StateHasChanged();

        return Task.CompletedTask;
    }

    private Task OnReasonChanged(string? v)
    {
        model.Reason = v ?? string.Empty;
        editContext.NotifyFieldChanged(
            new FieldIdentifier(model, nameof(model.Reason)));
        return Task.CompletedTask;
    }

    private static LeaveRequestViewModel Clone(LeaveRequestViewModel x) => new()
    {
        Id = x.Id,
        EmployeeId = x.EmployeeId,
        LeaveTypeId = x.LeaveTypeId,
        StartDate = x.StartDate,
        EndDate = x.EndDate,
        Reason = x.Reason,
        StatusId = x.StatusId
    };
}