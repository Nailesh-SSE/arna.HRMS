

@using Microsoft.AspNetCore.Components.Forms
@using arna.HRMS.ClientServices.Auth
@using arna.HRMS.ClientServices.Common
@using arna.HRMS.ClientServices.Leave
@using arna.HRMS.Models.ViewModels.Leave
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Components.lib.components.ui.Model

@inject ILeaveService LeaveService
@inject NotificationService NotificationService
@inherits AuthenticatedLayoutBase

@if (ShowModal)
{
    <div class="modal fade show d-block" tabindex="-1"
         style="background: rgba(0,0,0,0.45);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">
                        @(IsEditMode ? "Update Leave" : "Apply Leave")
                    </h5>
                    <button class="btn-close" @onclick="Close"></button>
                </div>

                <EditForm EditContext="editContext" OnValidSubmit="Save">
                    <DataAnnotationsValidator />

                    <div class="modal-body">

                        <AppSelect Label="Leave Type *"
                                   Options="LeaveOptions"
                                   Value="@(model.LeaveTypeId == 0 ? "" : model.LeaveTypeId.ToString())"
                                   ValueChanged="OnLeaveTypeChanged"
                                   ValidationExpression="() => model.LeaveTypeId"
                                   Placeholder="Select Leave..." />


                        <div class="row mt-3">
                            <div class="col-md-6">
                                <AppDatePicker Label="Start Date *"
                                               Value="@model.StartDate.Date"
                                               ValueChanged="OnStartChanged"
                                               ValidationExpression="() => model.StartDate"
                                               IsDateDisabled="IsDateDisabled" />
                            </div>

                            <div class="col-md-6">
                                <AppDatePicker Label="End Date *"
                                               Value="@model.EndDate.Date"
                                               ValueChanged="OnEndChanged"
                                               ValidationExpression="() => model.EndDate"
                                               IsDateDisabled="IsDateDisabled" />
                            </div>
                        </div>

                        @* <div class="mt-3">
                            <label>Total Days</label>
                            <div class="fw-bold">@model.TotalDays</div>
                        </div> *@

                        <AppTextArea Label="Reason *"
                                     Rows="4"
                                     Value="@model.Reason"
                                     ValueChanged="OnReasonChanged"
                                     ValidationExpression="() => model.Reason" />
                    </div>

                    <div class="modal-footer">
                        <AppButton type="button"
                                   class="btn btn-outline-secondary"
                                   Onclick="Close">
                            Cancel
                        </AppButton>

                        <AppButton type="submit"
                                   class="btn btn-primary"
                                   disabled="@isSubmitting">
                            @(IsEditMode ? "Update" : "Submit")
                        </AppButton>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}


@code {

    [Parameter] public bool ShowModal { get; set; }
    [Parameter] public EventCallback<bool> ShowModalChanged { get; set; }

    [Parameter] public LeaveRequestViewModel? SelectedRequest { get; set; }
    [Parameter] public List<SelectOption> LeaveOptions { get; set; } = new();
    [Parameter] public Func<DateTime, bool>? IsDateDisabled { get; set; }

    [Parameter] public EventCallback OnSaved { get; set; }

    private LeaveRequestViewModel model = new();
    private EditContext editContext = null!;
    private bool isSubmitting;
    private bool _initialized;

    private bool IsEditMode => SelectedRequest != null;

    protected override void OnParametersSet()
    {
        if (_initialized)
            return;

        model = SelectedRequest != null
            ? Clone(SelectedRequest)
            : new LeaveRequestViewModel
            {
                EmployeeId = GetEmployeeId(),
                StartDate = DateTime.Today,
                EndDate = DateTime.Today
            };

        editContext = new EditContext(model);
        _initialized = true;
    }

    private async Task Save()
    {
        isSubmitting = true;

        if (IsEditMode)
        {
            var result = await LeaveService.UpdateLeaveRequestAsync(model.Id, model);
            if (result?.IsSuccess == true)
                NotificationService.Success("Leave updated successfully.");
        }
        else
        {
            var result = await LeaveService.CreateLeaveRequestAsync(model);

            if (result?.IsSuccess == true)
            {
                NotificationService.Success("Leave submitted successfully.");
                await Close();
                await OnSaved.InvokeAsync();
            }
            else
            {
                NotificationService.Error(result?.Message ?? "Failed to submit leave.");
            }
        }

        isSubmitting = false;
        await Close();
        await OnSaved.InvokeAsync();
    }

    private async Task Close()
    {
        _initialized = false;   // 🔑 IMPORTANT
        await ShowModalChanged.InvokeAsync(false);
    }

    private Task OnLeaveTypeChanged(string? v)
    {
        model.LeaveTypeId = int.TryParse(v, out var id) ? id : 0;
        editContext.NotifyFieldChanged(
            new FieldIdentifier(model, nameof(model.LeaveTypeId)));
        return Task.CompletedTask;
    }

    private Task OnStartChanged(DateTime? d)
    {
        model.StartDate = (d ?? DateTime.Today).Date;

        editContext.NotifyFieldChanged(
            new FieldIdentifier(model, nameof(model.StartDate)));

        StateHasChanged(); 

        return Task.CompletedTask;
    }

    private Task OnEndChanged(DateTime? d)
    {
        model.EndDate = (d ?? DateTime.Today).Date;

        editContext.NotifyFieldChanged(
            new FieldIdentifier(model, nameof(model.EndDate)));

        StateHasChanged(); 

        return Task.CompletedTask;
    }

    private Task OnReasonChanged(string? v)
    {
        model.Reason = v ?? string.Empty;
        editContext.NotifyFieldChanged(
            new FieldIdentifier(model, nameof(model.Reason)));
        return Task.CompletedTask;
    }

    private static LeaveRequestViewModel Clone(LeaveRequestViewModel x) => new()
    {
        Id = x.Id,
        EmployeeId = x.EmployeeId,
        LeaveTypeId = x.LeaveTypeId,
        StartDate = x.StartDate,
        EndDate = x.EndDate,
        Reason = x.Reason,
        StatusId = x.StatusId
    };
}
