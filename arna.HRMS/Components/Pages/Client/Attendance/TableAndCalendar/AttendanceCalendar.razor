@using arna.HRMS.Models.ViewModels.Attendance

<div class="calendar-container">
    <div class="calendar-header">
        @foreach (var d in WeekDays)
        {
            <div>@d</div>
        }
    </div>

    <div class="calendar-grid">
        @foreach (var day in CalendarDays)
        {
            if (day is null)
            {
                <div class="calendar-cell empty"></div>
            }
            else
            {
                AttendanceLookup.TryGetValue(
                DateOnly.FromDateTime(day.Value),
                out var attendance
                );

                var emp = attendance?.Employees.FirstOrDefault();

                <div class="calendar-cell">
                    <div class="date">@day.Value.Day</div>

                    @if (emp != null)
                    {
                        <AttendanceIcon Status="@(emp.Status ?? "")" />

                        <div class="hours">
                            @(emp.ClockIn.HasValue && emp.ClockOut.HasValue 
                                ? emp.TotalHours.ToString(@"hh\:mm") + " hrs"
                                : "-")
                        </div>
                    }
                    else
                    {
                        <span class="calendar-status muted">No Data</span>
                    }
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired] public int Year { get; set; }
    [Parameter, EditorRequired] public int Month { get; set; }
    [Parameter, EditorRequired] public Dictionary<DateOnly, MonthlyAttendanceViewModel> AttendanceLookup { get; set; } = new();

    private List<DateTime?> CalendarDays = new();

    private static readonly string[] WeekDays =
        { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    protected override void OnParametersSet() => BuildCalendar();

    private void BuildCalendar()
    {
        CalendarDays.Clear();

        var firstDay = new DateTime(Year, Month, 1);
        var daysInMonth = DateTime.DaysInMonth(Year, Month);

        for (int i = 0; i < (int)firstDay.DayOfWeek; i++)
            CalendarDays.Add(null);

        for (int d = 1; d <= daysInMonth; d++)
            CalendarDays.Add(new DateTime(Year, Month, d));
    }
}
