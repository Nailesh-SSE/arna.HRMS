@page "/attendance"

@using arna.HRMS.ClientServices.Auth
@using arna.HRMS.ClientServices.Client.Attendance
@using arna.HRMS.Components.Loader
@using arna.HRMS.Components.Pages.Client.Attendance.AttendanceRequest
@using arna.HRMS.Components.Pages.Client.Attendance.MonthYearAndToggle
@using arna.HRMS.Components.Pages.Client.Attendance.Summary
@using arna.HRMS.Components.Pages.Client.Attendance.TableAndCalendar
@using arna.HRMS.Components.lib.components.ui.Forms
@using arna.HRMS.Helper.Attendance
@using arna.HRMS.Models.State.Attendance

@inject IAttendanceService AttendanceService
@inject AttendanceState State
@inherits AuthenticatedLayoutBase

<FullPageLoader Visible="@isLoading" />

<div class="attendance-dashboard">

    @if (!isLoading)
    {
        <!-- ================= HEADER ================= -->
        <div class="dashboard-header">
            <div class="d-flex align-items-center position-relative">
                <h2 class="mb-0">Attendance Overview</h2>

                <div class="ms-auto">
                    <AppButton Text="Request"
                               ButtonClass="btn btn-dark px-5"
                               OnClick="OpenDrawer" />
                </div>
            </div>

            <p class="text-muted mt-2">
                View and track your monthly attendance
            </p>
        </div>

        <!-- ================= SUMMARY ================= -->
        <AttendanceSummary SummaryCards="State.SummaryCards" />

        <!-- ================= TOTAL HOURS ================= -->
        <div class="hours-kpi">
            <div class="hours-info">
                <span class="hours-label">Total Working Hours</span>
            </div>

            <div class="hours-value">
                @State.TotalWorkingHours.ToString(@"hh\:mm")
                <span class="unit">hrs</span>
            </div>
        </div>

        <!-- ================= MONTH + VIEW TOGGLE ================= -->
        <div class="select-month-view-toggle">
            <SelectMonthAndYear Year="@State.Year"
                                Month="@State.Month"
                                OnChange="OnMonthSelected" />

            @if (IsAdmin() || IsSuperAdmin())
            {
                <AttendanceDateFilter Year="@State.Year"
                                      Month="@State.Month"
                                      SelectedDate="@State.SelectedDate"
                                      DateChanged="OnDateSelected" />
            }

            <AttendanceViewToggle ActiveView="@State.ViewMode"
                                  OnChange="SetView" />
        </div>

        <!-- ================= ADMIN vs EMPLOYEE VIEW ================= -->
        @if (IsAdmin() || IsSuperAdmin())
        {
            @if (State.ViewMode == AttendanceState.TABLE)
            {
                <EmployeeAttendanceDetailsView Attendance="State.AttendanceList" />
            }
        }
        else
        {
            @if (State.ViewMode == AttendanceState.TABLE)
            {
                <EmployeeAttendanceTableView Attendance="State.AttendanceList" />
            }
        }

        <!-- ================= CALENDAR VIEW ================= -->
        @if (State.ViewMode == AttendanceState.CALENDAR)
        {
            <AttendanceCalendar Year="@State.Year"
                                Month="@State.Month"
                                AttendanceLookup="State.AttendanceLookup" />
        }
    }

    <!-- ================= REQUEST DRAWER ================= -->
    <AttendanceRequestDrawer IsOpen="@isDrawerOpen"
                             IsOpenChanged="@(v => isDrawerOpen = v)"
                             Title="Attendance Request" />
</div>

@code {
    private bool isLoading = true;
    private bool hasLoaded;
    private bool isDrawerOpen;
    public DateTime? SelectedDate { get; set; }

    private void OpenDrawer()
        => isDrawerOpen = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || hasLoaded)
            return;

        hasLoaded = true;

        try
        {
            if (!IsAuthentication())
                return;

            if (string.IsNullOrWhiteSpace(State.SelectedMonth))
            {
                var now = DateTime.Today;
                State.Year = now.Year;
                State.Month = now.Month;
                State.SelectedMonth = $"{now.Year}-{now.Month:D2}";
            }
            else
            {
                State.ParseMonth();
            }

            await LoadData();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnMonthSelected((int year, int month) value)
    {
        State.Year = value.year;
        State.Month = value.month;
        State.SelectedMonth = $"{value.year}-{value.month:D2}";
        State.SelectedDate = null;
        await LoadData();
    }

    private async Task LoadData()
    {
        int empId;

        if (IsAdmin() || IsSuperAdmin())
        {
            empId = State.SelectedEmployeeId;
        }
        else
        {
            empId = GetEmployeeId();
            if (empId == 0)
                return;
        }

        // 🔥 LOAD GROUPED DATA
        State.AttendanceList =
            await AttendanceService.GetAttendanceByMonthAsync(
                State.Year,
                State.Month,
                empId,
                State.SelectedDate
            );

        // 🔥 LOOKUP FOR CALENDAR
        State.AttendanceLookup =
            State.AttendanceList.ToDictionary(x => x.Date);

        // 🔥 TOTAL WORKING HOURS (CORRECT FOR GROUPED MODEL)
        State.TotalWorkingHours =
            State.AttendanceList
                .SelectMany(d => d.Employees)
                .Aggregate(
                    TimeSpan.Zero,
                    (total, emp) => total + emp.TotalHours
                );

        // 🔥 SUMMARY
        State.SummaryCards =
            AttendanceSummaryBuilder.Build(State.AttendanceList);
    }

    private async Task OnDateSelected(DateTime? date)
    {
        State.SelectedDate = date;

        if (date.HasValue)
        {
            State.Year = date.Value.Year;
            State.Month = date.Value.Month;
            State.SelectedMonth = $"{State.Year}-{State.Month:D2}";
        }

        await LoadData();
    }

    private string MinDate =>
    new DateTime(State.Year, State.Month, 1).ToString("yyyy-MM-dd");

    private string MaxDate =>
        new DateTime(State.Year, State.Month, 1)
            .AddMonths(1)
            .AddDays(-1)
            .ToString("yyyy-MM-dd");

    private void SetView(string mode)
        => State.ViewMode = mode;
}
