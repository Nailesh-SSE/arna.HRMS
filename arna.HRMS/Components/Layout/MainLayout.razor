@using Microsoft.AspNetCore.Components.Routing
@using arna.HRMS.Components.Navbar
@using arna.HRMS.Services.Common

@implements IDisposable
@inherits LayoutComponentBase
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager

<div class="hrms-shell d-flex vh-100 overflow-hidden">

    @if (SidebarActive)
    {
        <div class="hrms-overlay d-lg-none" @onclick="ToggleSidebarAsync"></div>
    }

    <aside class="hrms-sidebar @(SidebarActive ? "active" : "")">
        <NavMenu OnClose="CloseSidebarAsync" />
    </aside>

    <div class="d-flex flex-column flex-grow-1 overflow-hidden">
        <Header OnToggleSidebar="ToggleSidebarAsync"
                SidebarActive="SidebarActive" />

        <main class="hrms-main flex-grow-1 overflow-auto p-3 p-lg-4">
            @Body
        </main>
    </div>
</div>

<div class="hrms-toast-wrapper position-fixed top-0 end-0 p-3">
    <Toasts Messages="NotificationService.Messages"
            Placement="ToastsPlacement.TopRight"
            Delay="4000" />
</div>

@code {
    private bool SidebarActive;
    private Func<Task>? _notificationHandler;

    protected override async Task OnInitializedAsync()
    {
        _notificationHandler = async () =>
        {
            await InvokeAsync(StateHasChanged);
        };

        NotificationService.OnChange += _notificationHandler;
        NavigationManager.LocationChanged += OnLocationChanged;

        await Task.CompletedTask;
    }

    private async Task ToggleSidebarAsync()
    {
        SidebarActive = !SidebarActive;
        await InvokeAsync(StateHasChanged);
    }

    private async Task CloseSidebarAsync()
    {
        if (SidebarActive)
        {
            SidebarActive = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (!SidebarActive)
            return;

        SidebarActive = false;
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (_notificationHandler is not null)
            NotificationService.OnChange -= _notificationHandler;

        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}