@using Microsoft.AspNetCore.Components.Authorization
@using arna.HRMS.ClientServices.Auth
@using arna.HRMS.Components.Pages.Attendance
@using arna.HRMS.Components.Pages.Auth
@using arna.HRMS.Components.Pages.Client.ClockInAndOut
@inject IJSRuntime JS
@inherits AuthenticatedLayoutBase

<header class="hrms-header" id="hrms-header">

    <!-- ══ ROW 1: Main bar — always visible ══ -->
    <div class="hrms-row1 d-flex align-items-center gap-2 px-2 px-lg-4">

        <!-- Toggle -->
        <button class="hrms-toggle btn border-0 d-flex align-items-center justify-content-center flex-shrink-0"
                @onclick="OnToggleSidebar" title="Toggle Sidebar" aria-label="Toggle Sidebar">
            <i class="bi @(IsSidebarOpen ? "bi-layout-sidebar" : "bi-layout-sidebar-reverse") fs-5"></i>
        </button>

        <!-- Greeting -->
        <div class="hrms-greeting d-flex flex-column lh-1 flex-shrink-0 me-auto">
            <span class="hrms-day">@GetDayLabel()</span>
            <span class="hrms-hello fw-semibold text-truncate">
                @Greeting@(!string.IsNullOrEmpty(GetUserFullName()) ? $", {GetUserFullName()}" : "")
            </span>
        </div>

        <!-- Right actions -->
        <div class="d-flex align-items-center gap-1 gap-lg-2 flex-shrink-0">

            <!-- Clock — lg+ only (desktop) -->
            <AuthorizeView Roles="Employee">
                <Authorized>
                    <div class="hrms-clock-desktop d-none d-lg-flex align-items-center gap-2">
                        <ClockInAndOut />
                    </div>
                </Authorized>
            </AuthorizeView>

            <div class="vr opacity-25 d-none d-lg-block" style="height:24px;"></div>

            <!-- Notifications -->
            <button class="hrms-icon-btn btn border-0 d-flex align-items-center justify-content-center flex-shrink-0"
                    title="Notifications" aria-label="Notifications">
                <NotificationDrawer />
            </button>

            <!-- User menu -->
            <div class="flex-shrink-0">
                <SimpleUserMenu />
            </div>
        </div>
    </div>

    <!-- ══ ROW 2: Clock bar — mobile & tablet only (< lg = < 992px) ══ -->
    <AuthorizeView Roles="Employee">
        <Authorized>
            <div class="hrms-clock-bar d-flex d-lg-none align-items-center justify-content-center gap-2 px-3">
                <ClockInAndOut />
            </div>
        </Authorized>
    </AuthorizeView>

</header>

@code {
    [Parameter] public EventCallback OnToggleSidebar { get; set; }
    [Parameter] public bool IsSidebarOpen { get; set; }

    private string Greeting = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        SetGreeting();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            await JS.InvokeVoidAsync("hrmsSetHeaderHeight");
        }
        catch { }
    }

    private void SetGreeting()
    {
        var hour = DateTime.Now.Hour;
        Greeting = hour switch
        {
            >= 5 and < 12 => "Good Morning",
            >= 12 and < 17 => "Good Afternoon",
            >= 17 and < 21 => "Good Evening",
            _ => "Good Night"
        };
    }

    private string GetDayLabel() =>
        DateTime.Now.ToString("ddd, dd MMM yyyy");

    private string GetInitials()
    {
        var name = GetUserFullName();
        if (string.IsNullOrWhiteSpace(name)) return "U";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[^1][0]}".ToUpper()
            : parts[0][0].ToString().ToUpper();
    }
}
