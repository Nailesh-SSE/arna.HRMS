@using Microsoft.AspNetCore.Components.Authorization
@using arna.HRMS.Components.Pages.Client.ClockInAndOut
@using arna.HRMS.Services.Auth


@inject IJSRuntime JS
@inherits AuthenticatedLayoutBase

<div class="header-root bg-white border-bottom shadow-sm">

    <!-- Row 1 — always visible -->
    <div class="header-row d-flex align-items-center gap-2 px-3 px-lg-4">

        <!-- Toggle Button -->
        <button class="header-toggle btn btn-light border-0 rounded-circle
                       d-flex align-items-center justify-content-center flex-shrink-0"
                @onclick="OnToggleSidebar"
                aria-label="Toggle Sidebar">

            <!-- Mobile icon: X when sidebar showing, hamburger when hidden -->
            <i class="bi d-lg-none @(SidebarActive ? "bi-x-lg" : "bi-list") fs-5"></i>

            <!-- Desktop icon: hamburger when sidebar hidden, sidebar-icon when visible -->
            <i class="bi d-none d-lg-inline @(SidebarActive ? "bi-list" : "bi-layout-sidebar-inset") fs-5"></i>
        </button>

        <!-- Greeting -->
        <div class="header-greeting d-flex flex-column lh-sm me-auto overflow-hidden">
            <small class="header-day text-muted">@GetDayLabel()</small>
            <span class="header-hello fw-semibold text-truncate">
                @Greeting@(!string.IsNullOrEmpty(GetUserFullName()) ? $", {GetUserFullName()}" : "")
            </span>
        </div>

        <!-- Right actions -->
        <div class="d-flex align-items-center gap-2 flex-shrink-0">

            <!-- Clock — desktop only -->
            <AuthorizeView Roles="Employee">
                <Authorized>
                    <div class="d-none d-lg-flex align-items-center gap-2">
                        <ClockInAndOut />
                    </div>
                    <div class="header-divider vr opacity-25 d-none d-lg-block"></div>
                </Authorized>
            </AuthorizeView>

            <!-- Notifications -->
            <NotificationDrawer />

            <UserMenu />
        </div>
    </div>

    <!-- Row 2 — clock bar, mobile & tablet only -->
    <AuthorizeView Roles="Employee">
        <Authorized>
            <div class="header-clock-bar d-flex d-lg-none align-items-center
                        justify-content-center gap-2 px-3 py-2 border-top">
                <ClockInAndOut />
            </div>
        </Authorized>
    </AuthorizeView>
</div>

@code {
    [Parameter] public EventCallback OnToggleSidebar { get; set; }
    [Parameter] public bool SidebarActive { get; set; }

    private string Greeting = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        SetGreeting();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            await JS.InvokeVoidAsync("hrmsSetHeaderHeight");
        }
        catch { }
    }

    private void SetGreeting()
    {
        var hour = DateTime.Now.Hour;
        Greeting = hour switch
        {
            >= 5 and < 12 => "Good Morning",
            >= 12 and < 17 => "Good Afternoon",
            >= 17 and < 21 => "Good Evening",
            _ => "Good Night"
        };
    }

    private string GetDayLabel() =>
        DateTime.Now.ToString("ddd, dd MMM yyyy");

    private string GetInitials()
    {
        var name = GetUserFullName();
        if (string.IsNullOrWhiteSpace(name)) return "U";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[^1][0]}".ToUpper()
            : parts[0][0].ToString().ToUpper();
    }
}